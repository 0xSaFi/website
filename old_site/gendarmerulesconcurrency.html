---
layout: obsolete
title: "Gendarme.Rules.Concurrency"
permalink: /old_site/Gendarme.Rules.Concurrency/
redirect_from:
  - /Gendarme.Rules.Concurrency/
---

<h1>Gendarme.Rules.Concurrency</h1>

<p><a href="{{site.baseurl}}/old_site/Gendarme" title="Gendarme">Gendarme</a>'s concurrency rules are located in the <b>Gendarme.Rules.Concurrency.dll</b> assembly.
Latest sources are available from 
<a href="http://anonsvn.mono-project.com/viewcvs/trunk/mono-tools/gendarme/rules/Gendarme.Rules.Concurrency/" class="external text" rel="nofollow">anonymous SVN</a>.
</p>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Rules"><span class="tocnumber">1</span> <span class="toctext">Rules</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#DoNotLockOnThisOrTypesRule"><span class="tocnumber">1.1</span> <span class="toctext">DoNotLockOnThisOrTypesRule</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#DoNotLockOnWeakIdentityObjectsRule"><span class="tocnumber">1.2</span> <span class="toctext">DoNotLockOnWeakIdentityObjectsRule</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#DoNotUseLockedRegionOutsideMethodRule"><span class="tocnumber">1.3</span> <span class="toctext">DoNotUseLockedRegionOutsideMethodRule</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#DoNotUseMethodImplOptionsSynchronizedRule"><span class="tocnumber">1.4</span> <span class="toctext">DoNotUseMethodImplOptionsSynchronizedRule</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#DoNotUseThreadStaticWithInstanceFieldsRule"><span class="tocnumber">1.5</span> <span class="toctext">DoNotUseThreadStaticWithInstanceFieldsRule</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#DoubleCheckLockingRule"><span class="tocnumber">1.6</span> <span class="toctext">DoubleCheckLockingRule</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#NonConstantStaticFieldsShouldNotBeVisibleRule"><span class="tocnumber">1.7</span> <span class="toctext">NonConstantStaticFieldsShouldNotBeVisibleRule</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#ProtectCallToEventDelegatesRule"><span class="tocnumber">1.8</span> <span class="toctext">ProtectCallToEventDelegatesRule</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#ReviewLockUsedOnlyForOperationsOnVariablesRule"><span class="tocnumber">1.9</span> <span class="toctext">ReviewLockUsedOnlyForOperationsOnVariablesRule</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#WriteStaticFieldFromInstanceMethodRule"><span class="tocnumber">1.10</span> <span class="toctext">WriteStaticFieldFromInstanceMethodRule</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-12"><a href="#Feedback"><span class="tocnumber">2</span> <span class="toctext">Feedback</span></a></li>
</ul>
</td></tr></table>
<h1> <span class="mw-headline" id="Rules"> Rules </span></h1>
<h3> <span class="mw-headline" id="DoNotLockOnThisOrTypesRule"> DoNotLockOnThisOrTypesRule </span></h3>
<p>This rule checks if you're using <b>lock</b> on the current instance (<b>this</b>) or on a <b>Type</b>. This can cause problems because anyone can acquire a lock on the instance or type. And if another thread does acquire a lock then deadlocks become a very real possibility. The preferred way to handle this is to create a private <b>System.Object</b> instance field and <b>lock</b> that. This greatly reduces the scope of the code which may acquire the lock which makes it much easier to ensure that the locking is done correctly. 
</p><p><b>Bad</b> example (this):
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> MethodLockingOnThis <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span><span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
        producer<span style="color: #008000;">++;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Bad</b> example (type):
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> MethodLockingOnType <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span><span style="color: #0600FF; font-weight: bold;">this</span><span style="color: #008000;">.</span><span style="color: #0000FF;">GetType</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
        producer<span style="color: #008000;">++;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #6666cc; font-weight: bold;">class</span> ClassWithALocker <span style="color: #008000;">&#123;</span>
    <span style="color: #6666cc; font-weight: bold;">object</span> locker <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> <span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #6666cc; font-weight: bold;">int</span> producer <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span>
&#160;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> MethodLockingLocker <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
    <span style="color: #008000;">&#123;</span>
        <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span>locker<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
            producer<span style="color: #008000;">++;</span>
        <span style="color: #008000;">&#125;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><br />
</p>
<h3> <span class="mw-headline" id="DoNotLockOnWeakIdentityObjectsRule"> DoNotLockOnWeakIdentityObjectsRule </span></h3>
<p>This rule ensures there are no locks on objects with weak identity. An object with weak identity is one that can be directly accessed across different application domains. Because these objects can be accessed by different application domains it is very difficult to ensure that the locking is done correctly so problems such as deadlocks are much more likely. The following types have a weak identities: 
</p>
<ul><li> <b>System.MarshalByRefObject</b>
</li><li> <b>System.OutOfMemoryException</b>
</li><li> <b>System.Reflection.MemberInfo</b>
</li><li> <b>System.Reflection.ParameterInfo</b>
</li><li> <b>System.ExecutionEngineException</b>
</li><li> <b>System.StackOverflowException</b>
</li><li> <b>System.String</b>
</li><li> <b>System.Threading.Thread</b>
</li></ul>
<p><br />
<b>Bad</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> WeakIdLocked <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;CustomString&quot;</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
        <span style="color: #008080; font-style: italic;">// ...</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> WeakIdNotLocked <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
    Phone phone <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> Phone <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span>phone<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
        <span style="color: #008080; font-style: italic;">// ...</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><br />
</p>
<h3> <span class="mw-headline" id="DoNotUseLockedRegionOutsideMethodRule"> DoNotUseLockedRegionOutsideMethodRule </span></h3>
<p>This rule will fire if a method calls <b>System.Threading.Monitor.Enter</b>, but not <b>System.Threading.Monitor.Exit</b>. This is a bad idea for public methods because the callers must (indirectly) manage a lock which they do not own. This increases the potential for problems such as dead locks because locking/unlocking may not be done together, the callers must do the unlocking even in the presence of exceptions, and it may not be completely clear that the public method is acquiring a lock without releasing it. This is less of a problem for private methods because the lock is managed by code that owns the lock. So, it's relatively easy to analyze the class to ensure that the lock is locked and unlocked correctly and that any invariants are preserved when the lock is acquired and after it is released. However it is usually simpler and more maintainable if methods unlock whatever they lock. 
</p><p><b>Bad</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #6666cc; font-weight: bold;">class</span> BadExample <span style="color: #008000;">&#123;</span>
    <span style="color: #6666cc; font-weight: bold;">int</span> producer <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span>
    <span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> <span style="color: #6666cc; font-weight: bold;">object</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&#160;
    <span style="color: #008080; font-style: italic;">// This class is meant to be thread safe, but in the interests of</span>
    <span style="color: #008080; font-style: italic;">// performance it requires clients to manage its lock. This allows</span>
    <span style="color: #008080; font-style: italic;">// clients to grab the lock, batch up edits, and release the lock</span>
    <span style="color: #008080; font-style: italic;">// when they are done. But this means that the clients must</span>
    <span style="color: #008080; font-style: italic;">// now (implicitly) manage the lock which is problematic, especially</span>
    <span style="color: #008080; font-style: italic;">// if this object is shared across threads.</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> BeginEdits <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
    <span style="color: #008000;">&#123;</span>
        Monitor<span style="color: #008000;">.</span><span style="color: #0000FF;">Enter</span> <span style="color: #008000;">&#40;</span><span style="color: #0600FF; font-weight: bold;">lock</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
&#160;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> AddProducer <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
    <span style="color: #008000;">&#123;</span>
        <span style="color: #008080; font-style: italic;">// Real code would either assert or throw if the lock is not held.</span>
        producer<span style="color: #008000;">++;</span>
    <span style="color: #008000;">&#125;</span>
&#160;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> EndEdits <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
    <span style="color: #008000;">&#123;</span>
        Monitor<span style="color: #008000;">.</span><span style="color: #0000FF;">Exit</span> <span style="color: #008000;">&#40;</span><span style="color: #0600FF; font-weight: bold;">lock</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #6666cc; font-weight: bold;">class</span> GoodExample <span style="color: #008000;">&#123;</span>
    <span style="color: #6666cc; font-weight: bold;">int</span> producer <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span>
    <span style="color: #6666cc; font-weight: bold;">object</span> mutex <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> <span style="color: #6666cc; font-weight: bold;">object</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&#160;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> AddProducer <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
    <span style="color: #008000;">&#123;</span>
        <span style="color: #008080; font-style: italic;">// We need a try block in case the assembly is compiled with</span>
        <span style="color: #008080; font-style: italic;">// checked arithmetic.</span>
        Monitor<span style="color: #008000;">.</span><span style="color: #0000FF;">Enter</span> <span style="color: #008000;">&#40;</span>mutex<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
        <span style="color: #0600FF; font-weight: bold;">try</span> <span style="color: #008000;">&#123;</span>
            producer<span style="color: #008000;">++;</span>
            <span style="color: #008000;">&#125;</span> <span style="color: #0600FF; font-weight: bold;">finally</span> <span style="color: #008000;">&#123;</span>
                Monitor<span style="color: #008000;">.</span><span style="color: #0000FF;">Exit</span> <span style="color: #008000;">&#40;</span>mutex<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
            <span style="color: #008000;">&#125;</span>
        <span style="color: #008000;">&#125;</span>
&#160;
        <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> AddProducer2 <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
        <span style="color: #008000;">&#123;</span>
            <span style="color: #008080; font-style: italic;">// Same as the above, but with C# sugar.</span>
            <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span>mutex<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                producer<span style="color: #008000;">++;</span>
            <span style="color: #008000;">&#125;</span>
        <span style="color: #008000;">&#125;</span>
    <span style="color: #008000;">&#125;</span></pre>
<p><br />
</p>
<h3> <span class="mw-headline" id="DoNotUseMethodImplOptionsSynchronizedRule"> DoNotUseMethodImplOptionsSynchronizedRule </span></h3>
<p>This rule fires if a method is decorated with <b>[MethodImpl(MethodImplOptions.Synchronized)]</b>. The runtime synchronizes those methods automatically using a <b>lock(this)</b> for instance methods or a <b>lock(typeof(X))</b> for static methods. This can cause problems because anyone can acquire a lock on the instance or type. And if another thread does acquire a lock then deadlocks become a very real possibility. The preferred way to handle this is to create a private <b>System.Object</b> instance field and <b>lock</b> that. This greatly reduces the scope of the code which may acquire the lock which makes it much easier to ensure that the locking is done correctly. 
</p><p><b>Bad</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #008000;">&#91;</span>MethodImpl <span style="color: #008000;">&#40;</span>MethodImplOptions<span style="color: #008000;">.</span><span style="color: #0000FF;">Synchronized</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#93;</span>
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> SychronizedMethod <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
    producer<span style="color: #008000;">++;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> ClassWithALocker <span style="color: #008000;">&#123;</span>
    <span style="color: #6666cc; font-weight: bold;">object</span> locker <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> <span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #6666cc; font-weight: bold;">int</span> producer <span style="color: #008000;">=</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span>
&#160;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> MethodLockingLocker <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
    <span style="color: #008000;">&#123;</span>
        <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span>locker<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
            producer<span style="color: #008000;">++;</span>
        <span style="color: #008000;">&#125;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><br />
</p>
<h3> <span class="mw-headline" id="DoNotUseThreadStaticWithInstanceFieldsRule"> DoNotUseThreadStaticWithInstanceFieldsRule </span></h3>
<p>This rule will fire if an instance field is decorated with a <b>[ThreadStatic]</b> attribute. This is an error because the attribute will only work with static fields. 
</p><p><b>Bad</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #008080; font-style: italic;">// the field isn't static so this will do nothing</span>
<span style="color: #008000;">&#91;</span>ThreadStatic<span style="color: #008000;">&#93;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> List<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">object</span><span style="color: #008000;">&gt;</span> items<span style="color: #008000;">;</span>
&#160;
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> <span style="color: #0600FF; font-weight: bold;">Add</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">object</span> item<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
    <span style="color: #008080; font-style: italic;">// If the field was thread safe this would ensure that each thread had</span>
    <span style="color: #008080; font-style: italic;">// its own copy of the list.</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>items <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
        items <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> List<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">object</span><span style="color: #008000;">&gt;</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
&#160;
    items<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Add</span> <span style="color: #008000;">&#40;</span>item<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">private</span> List<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">object</span><span style="color: #008000;">&gt;</span> items <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> List<span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">object</span><span style="color: #008000;">&gt;</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #6666cc; font-weight: bold;">object</span> mutex <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> <span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&#160;
<span style="color: #008080; font-style: italic;">// Typically some form of locking such as the code below is used to</span>
<span style="color: #008080; font-style: italic;">// serialize access to instance fields. However you can also use</span>
<span style="color: #008080; font-style: italic;">// Threading.Thread.Thread::AllocateNamedDataSlot or AllocateDataSlot.</span>
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">void</span> <span style="color: #0600FF; font-weight: bold;">Add</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">object</span> item<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span>mutex<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
        items<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Add</span> <span style="color: #008000;">&#40;</span>item<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Notes</b>
</p>
<ul><li> This rule is available since Gendarme 2.6
</li></ul>
<h3> <span class="mw-headline" id="DoubleCheckLockingRule"> DoubleCheckLockingRule </span></h3>
<p>This rule is used to check for the double-check pattern, often used when implementing the singleton pattern (1), and warns of potential incorrect usage. The original CLR (1.x) could not guarantee that a double-check would work correctly in multithreaded applications. However the technique does work on the x86 architecture, the most common architecture, so the problem is seldom seen (e.g. IA64). The CLR 2 and later introduce a strong memory model (2) where a double check for a <b>lock</b> is correct (as long as you assign to a <b>volatile</b> variable). This rule won't report a defect for assemblies targetting the 2.0 (and later) runtime. 
</p>
<ul><li> <b>1. Implementing Singleton in C#</b>&#160;: <a href="http://msdn.microsoft.com/en-us/library/ms998558.aspx" class="external free" rel="nofollow">http://msdn.microsoft.com/en-us/library/ms998558.aspx</a>
</li><li> <b>2. Understand the Impact of Low-Lock Techniques in Multithreaded Apps</b>&#160;: <a href="http://msdn.microsoft.com/en-ca/magazine/cc163715.aspx#S5" class="external free" rel="nofollow">http://msdn.microsoft.com/en-ca/magazine/cc163715.aspx#S5</a>
</li></ul>
<p><br />
<b>Bad</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> Singleton <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> Singleton instance<span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">object</span> syncRoot <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> <span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&#160;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> Singleton Instance <span style="color: #008000;">&#123;</span>
        <span style="color: #0600FF; font-weight: bold;">get</span> <span style="color: #008000;">&#123;</span>
            <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>instance <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span>syncRoot<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>instance <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                        instance <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> Singleton <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
                    <span style="color: #008000;">&#125;</span>
                <span style="color: #008000;">&#125;</span>
            <span style="color: #008000;">&#125;</span>
            <span style="color: #0600FF; font-weight: bold;">return</span> instance<span style="color: #008000;">;</span>
        <span style="color: #008000;">&#125;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example (for 1.x code avoid using double check):
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> Singleton <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> Singleton instance<span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">object</span> syncRoot <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> <span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&#160;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> Singleton Instance <span style="color: #008000;">&#123;</span>
        <span style="color: #0600FF; font-weight: bold;">get</span> <span style="color: #008000;">&#123;</span>
            <span style="color: #008080; font-style: italic;">// do not check instance before the lock</span>
            <span style="color: #008080; font-style: italic;">// this will work on all CLRs but will affect</span>
            <span style="color: #008080; font-style: italic;">// performance since the lock is always acquired</span>
            <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span>syncRoot<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>instance <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                    instance <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> Singleton <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
                <span style="color: #008000;">&#125;</span>
            <span style="color: #008000;">&#125;</span>
            <span style="color: #0600FF; font-weight: bold;">return</span> instance<span style="color: #008000;">;</span>
        <span style="color: #008000;">&#125;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example (for 2.x and later):
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> Singleton <span style="color: #008000;">&#123;</span>
    <span style="color: #008080; font-style: italic;">// by using 'volatile' the double check will work under CLR 2.x</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #0600FF; font-weight: bold;">volatile</span> Singleton instance<span style="color: #008000;">;</span>
    <span style="color: #0600FF; font-weight: bold;">private</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">object</span> syncRoot <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> <span style="color: #6666cc; font-weight: bold;">object</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
&#160;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> Singleton Instance <span style="color: #008000;">&#123;</span>
        <span style="color: #0600FF; font-weight: bold;">get</span> <span style="color: #008000;">&#123;</span>
            <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>instance <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                <span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span>syncRoot<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>instance <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
                        instance <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> Singleton <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
                    <span style="color: #008000;">&#125;</span>
                <span style="color: #008000;">&#125;</span>
            <span style="color: #008000;">&#125;</span>
            <span style="color: #0600FF; font-weight: bold;">return</span> instance<span style="color: #008000;">;</span>
        <span style="color: #008000;">&#125;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><br />
</p>
<h3> <span class="mw-headline" id="NonConstantStaticFieldsShouldNotBeVisibleRule"> NonConstantStaticFieldsShouldNotBeVisibleRule </span></h3>
<p>This rule warns if a non-constant public static field is found. In a multi-threaded environment access to those fields must be synchronized. 
</p><p><b>Bad</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #6666cc; font-weight: bold;">class</span> HasPublicStaticField <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> ComplexObject Field<span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #6666cc; font-weight: bold;">class</span> FieldIsReadonly <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">readonly</span> <span style="color: #0600FF; font-weight: bold;">static</span> ComplexObject Field <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> ComplexObject<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span></pre>
<pre class="csharp" style="font-family:monospace;"><span style="color: #6666cc; font-weight: bold;">class</span> UseThreadStatic <span style="color: #008000;">&#123;</span>
    <span style="color: #008000;">&#91;</span>ThreadStatic<span style="color: #008000;">&#93;</span>
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> ComplexObject Field<span style="color: #008000;">;</span>
&#160;
    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> InitializeThread <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span>
    <span style="color: #008000;">&#123;</span>
        <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>Field <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span>
        Field <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> ComplexObject <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><br />
</p>
<h3> <span class="mw-headline" id="ProtectCallToEventDelegatesRule"> ProtectCallToEventDelegatesRule </span></h3>
<p>This rule checks that event invocations are safely implemented. In particular, the event must be copied into a local to avoid race conditions and it must be checked for null before it is used (events will normally be null until a delegate is added to them). 
</p><p><b>Bad</b> example (no check):
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">event</span> EventHandler Loading<span style="color: #008000;">;</span>
&#160;
<span style="color: #0600FF; font-weight: bold;">protected</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnLoading <span style="color: #008000;">&#40;</span>EventArgs e<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
    <span style="color: #008080; font-style: italic;">// Loading field could be null, throwing a NullReferenceException</span>
    Loading <span style="color: #008000;">&#40;</span><span style="color: #0600FF; font-weight: bold;">this</span>, e<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Bad</b> example (race condition):
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">event</span> EventHandler Loading<span style="color: #008000;">;</span>
&#160;
<span style="color: #0600FF; font-weight: bold;">protected</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnLoading <span style="color: #008000;">&#40;</span>EventArgs e<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
    <span style="color: #008080; font-style: italic;">// Loading could be non-null here</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>Loading <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
        <span style="color: #008080; font-style: italic;">// but be null once we get here&#160;:(</span>
        Loading <span style="color: #008000;">&#40;</span><span style="color: #0600FF; font-weight: bold;">this</span>, e<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">event</span> EventHandler Loading<span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">protected</span> <span style="color: #6666cc; font-weight: bold;">void</span> OnLoading <span style="color: #008000;">&#40;</span>EventArgs e<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
    EventHandler handler <span style="color: #008000;">=</span> Loading<span style="color: #008000;">;</span>
    <span style="color: #008080; font-style: italic;">// handler is either null or non-null</span>
    <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>handler <span style="color: #008000;">!=</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
        <span style="color: #008080; font-style: italic;">// and won't change (i.e. safe from a NullReferenceException)</span>
        handler <span style="color: #008000;">&#40;</span><span style="color: #0600FF; font-weight: bold;">this</span>, e<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
        <span style="color: #008080; font-style: italic;">// however it is still possible, like the original code, that</span>
        <span style="color: #008080; font-style: italic;">// the Loading method will be removed before, or during its</span>
        <span style="color: #008080; font-style: italic;">// execution. Your code should be safe against such occurance.</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><br />
</p>
<h3> <span class="mw-headline" id="ReviewLockUsedOnlyForOperationsOnVariablesRule"> ReviewLockUsedOnlyForOperationsOnVariablesRule </span></h3>
<p>This rule checks if a lock is used only to perform operations on locals or fields. If the only purpose of that critical section is to make sure the variables are modified atomatically then the methods provided by System.Threading.Interlocked class will be more efficient. 
</p><p><b>Bad</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span>_lockObject<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
    _counter<span style="color: #008000;">++;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example:
</p>
<pre class="csharp" style="font-family:monospace;">Interlocked<span style="color: #008000;">.</span><span style="color: #0000FF;">Increment</span><span style="color: #008000;">&#40;</span>_counter<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></pre>
<p><b>Bad</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">lock</span> <span style="color: #008000;">&#40;</span>_lockObject<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
    _someSharedObject <span style="color: #008000;">=</span> anotherObject<span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example:
</p>
<pre class="csharp" style="font-family:monospace;">Interlocked<span style="color: #008000;">.</span><span style="color: #0000FF;">Exchange</span><span style="color: #008000;">&#40;</span>_someSharedObject, anotherObject<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></pre>
<p><br />
</p>
<h3> <span class="mw-headline" id="WriteStaticFieldFromInstanceMethodRule"> WriteStaticFieldFromInstanceMethodRule </span></h3>
<p>This rule is used to check for instance methods which write values to static fields. This may cause problems if multiple instances of the type exist and are used in multithreaded applications. 
</p><p><b>Bad</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">int</span> default_value<span style="color: #008000;">;</span>
&#160;
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">int</span> <span style="color: #0600FF; font-weight: bold;">Value</span> <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">get</span> <span style="color: #008000;">&#123;</span>
        <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>default_value <span style="color: #008000;">==</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
            default_value <span style="color: #008000;">=</span> <span style="color: #008000;">-</span><span style="color: #FF0000;">1</span><span style="color: #008000;">;</span>
        <span style="color: #008000;">&#125;</span>
        <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">&#40;</span><span style="color: #0600FF; font-weight: bold;">value</span> <span style="color: #008000;">&gt;</span> default_value<span style="color: #008000;">&#41;</span> <span style="color: #008000;">?</span> <span style="color: #0600FF; font-weight: bold;">value</span> <span style="color: #008000;">:</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><b>Good</b> example:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">int</span> default_value <span style="color: #008000;">=</span> <span style="color: #008000;">-</span><span style="color: #FF0000;">1</span><span style="color: #008000;">;</span>
&#160;
<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">int</span> <span style="color: #0600FF; font-weight: bold;">Value</span> <span style="color: #008000;">&#123;</span>
    <span style="color: #0600FF; font-weight: bold;">get</span> <span style="color: #008000;">&#123;</span>
        <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #008000;">&#40;</span><span style="color: #0600FF; font-weight: bold;">value</span> <span style="color: #008000;">&gt;</span> default_value<span style="color: #008000;">&#41;</span> <span style="color: #008000;">?</span> <span style="color: #0600FF; font-weight: bold;">value</span> <span style="color: #008000;">:</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span>
    <span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p><br />
</p>
<h1> <span class="mw-headline" id="Feedback"> Feedback </span></h1>
<p>Please report any documentation errors, typos or suggestions to the 
<a href="http://groups.google.com/group/gendarme" class="external text" rel="nofollow">Gendarme Google Group</a>. Thanks!
</p>
