---
layout: obsolete
title: "Mono Runtime API Changes"
permalink: /old_site/Mono_Runtime_API_Changes/
redirect_from:
  - /Mono_Runtime_API_Changes/
---

<h1>Mono Runtime API Changes</h1>

<p>API changes that we need to make to the Mono Runtime for Mono 2.8:
</p>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Tasks"><span class="tocnumber">1</span> <span class="toctext">Tasks</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#API_incompatibilities"><span class="tocnumber">2</span> <span class="toctext">API incompatibilities</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#API_improvements"><span class="tocnumber">3</span> <span class="toctext">API improvements</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#API_Additions"><span class="tocnumber">4</span> <span class="toctext">API Additions</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Open_for_debate"><span class="tocnumber">5</span> <span class="toctext">Open for debate</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="#Open_questions"><span class="tocnumber">5.1</span> <span class="toctext">Open questions</span></a></li>
</ul>
</li>
</ul>
</td></tr></table>
<h1> <span class="mw-headline" id="Tasks"> Tasks </span></h1>
<p>Drop the MONO_ZERO_LEN_ARRAY from the public header files currently based on the __GNUC__.   
</p>
<ul><li> Instead use a mono-configuration.h for the system where MOno is compiled.
</li></ul>
<ul><li> or, define MONO_ZERO_LEN_ARRAY to be the empty string so as to depend on the C99 flexible array feature.  This avoids the issues with installing a build-time header mono-configuration.h (see shenanigans with glib-config.h in the glib package, not to mention the issues with having an installed header customized for a particular compiler).  Note that GCC claim support for C99 flexible arrays since at least GCC 3.0, and C99 is a 10 year old standard already
</li></ul>
<p>Drop the current verifier API and make it saner. On its current form it is not very usable and it returns a GList, which is not very helpful.
</p><p>Drop all uses of glib on public API. This will make the transition to eglib possible.
</p><p>Make use of the upcoming error handling API in all functions that mutate the runtime state. This is a pretty wide change as a huge number of functions will change signature.
</p>
<h1> <span class="mw-headline" id="API_incompatibilities"> API incompatibilities </span></h1>
<table border="1" cellpadding="5" cellspacing="0">
<tr>
<th> API/ABI issue </th>
<th> Solution/workaround
</th></tr>
<tr>
<td> libmono will have a different soname and the mono header files will be in a different place.
</td>
<td> Use pkg-config --cflags mono2 and pkg-config --libs mono2 to compile and link, respectively, instead of using the old "mono" package name.
</td></tr>
<tr>
<td> The GLib header will no longer be included in mono header files, since no GLib type will be used in the public functions.
</td>
<td> Include glib.h in your own files if you use GLib functionality. You'll also need to use pkg-config --cflags glib-2.0 and pkg-config --libs glib-2.0 to compile and link, respectively
</td></tr>
<tr>
<td> The MonoType struct will become opaque.
</td>
<td> Use the existing accessor functions instead of peeking inside the fields directly.
</td></tr>
<tr>
<td> The MonoMethodSignature struct will become opaque.
</td>
<td> Use the existing accessor functions instead of peeking inside the fields directly.
</td></tr>
<tr>
<td> The MonoMarshalSpec struct will be hidden and all the public functions using it will become private.
</td>
<td> If you need to access the marshal info you'll have to decode from the metadata tables.
</td></tr>
<tr>
<td> The MonoRemoteClass struct will be removed along with the mono_remote_class() function.
</td>
<td> Embedders should have no need to access this struct.
</td></tr>
<tr>
<td> Managed structs and classes containing references cannot be freely manipulated any longer, to take into consideration the moving GC.
</td>
<td> Every time a reference field (or a valuetype containing in any way a reference field) is set, it must be done using one of the mono_gc_wbarrie*() set of funtcions. This applies also to arrays containing references.
</td></tr>
<tr>
<td> The MonoObject, MonoArray and MonoString structs may become opaque.
</td>
<td> Use only the existing accessor macros and functions to access their internals.
</td></tr>
<tr>
<td> The MonoAssemblyName struct will become opaque.
</td>
<td> Ways to allocate it and access it will be provided.
</td></tr>
<tr>
<td> The mono_image_add_to_name_cache() functions will be removed.
</td>
<td> There is no use for it for embedders.
</td></tr>
<tr>
<td> The MonoCustomAttrInfo and MonoCustomAttrEntry structs will become opaque
</td>
<td> Appropriate accessors will be available.
</td></tr>
<tr>
<td> The MonoReflectionMethodAux struct will e removed
</td>
<td> There is no use for it for embedders.
</td></tr>
<tr>
<td> The sizes and lobounds fields in MonoArrayType will change type to a pointer-sized integer.
</td>
<td> Don't make assumptions about the fields (in particular that you could create large arrays on 64 bit systems) until the ABI break point.
</td></tr>
<tr>
<td> The current verify interface will be removed. It's use is debatable so we need feedback from use about it's need.
</td>
<td> The right solution for most users is to enable CoreCLR security.
</td></tr>
<tr>
<td> The current loader error system will disappear together with it's API. This is a semantic change that is an implicit part of the API.
</td>
<td> The new way will be more reliable and less forgiving, so it should be a clean win for users.
</td></tr></table>
<h1> <span class="mw-headline" id="API_improvements"> API improvements </span></h1>
<p>Extend the runtime API to handle generics. This is often requested on MDL.
</p><p>Change functions like mono_method_get_param_names and mono_method_get_marshal_info to return failure.
</p>
<h1> <span class="mw-headline" id="API_Additions"> API Additions </span></h1>
<p>Add functions to retrieve all parameter information such as flags. Maybe a single function that return a [name, flags, marshal_info?] tuple.
</p><p><br />
</p>
<h1> <span class="mw-headline" id="Open_for_debate"> Open for debate </span></h1>
<p>Make most, if not all, Mono* types opaque so we can more easily change their internals. Some structs are used as input and the user is supposed to fill them so they have to remain there.
</p><p>Most functions will take an extra MonoError struct to provide better error handling. If we do that, this will break a huge ammount of functions. Should we keep the old unsafe equivalents?
</p>
<h3> <span class="mw-headline" id="Open_questions"> Open questions </span></h3>
<p>Should we provide some sort of backward compatibility with the V1 API using symbol renaming and linker tricks such as the one libc uses?
</p>
