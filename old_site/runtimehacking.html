---
layout: obsolete
title: "RuntimeHacking"
permalink: /old_site/RuntimeHacking/
---

<h1>RuntimeHacking</h1>

<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Runtime_hacking_tips_and_tricks"><span class="tocnumber">1</span> <span class="toctext">Runtime hacking tips and tricks</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Coding_style"><span class="tocnumber">2</span> <span class="toctext">Coding style</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Testing_changes"><span class="tocnumber">3</span> <span class="toctext">Testing changes</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Profiling_and_statistics"><span class="tocnumber">4</span> <span class="toctext">Profiling and statistics</span></a></li>
<li class="toclevel-1 tocsection-5"><a href="#Runtime_areas_and_their_maintainers"><span class="tocnumber">5</span> <span class="toctext">Runtime areas and their maintainers</span></a></li>
</ul>
</td></tr></table>
<h2> <span class="mw-headline" id="Runtime_hacking_tips_and_tricks"> Runtime hacking tips and tricks </span></h2>
<h2> <span class="mw-headline" id="Coding_style"> Coding style </span></h2>
<p>Take the following examples as a reference of how the code should look like:
</p>
<pre class="c" style="font-family:monospace;"><span style="color: #808080; font-style: italic;">/*
 * Multiline comment documenting a function definition
 * Note that the return type is in its own line and braces
 * for the function are on their own line as well.
 * There must be a space after the function name and the opening parenthesis
 * both in the definition and when any function or macro is called.
 */</span>
<span style="color: #993333;">static</span> MonoType<span style="color: #339933;">*</span>
get_mono_type_from_name <span style="color: #009900;">&#40;</span><span style="color: #993333;">char</span> <span style="color: #339933;">*</span>name<span style="color: #009900;">&#41;</span>
<span style="color: #009900;">&#123;</span>
        <span style="color: #808080; font-style: italic;">/* 
         * Always indent with TAB characters, never use spaces to indent code
         * Don't mix code and local declarations: older compilers don't support that.
         */</span>
        MonoType <span style="color: #339933;">*</span>return_type<span style="color: #339933;">;</span>
&#160;
        <span style="color: #808080; font-style: italic;">/*
         * Simple one-line conditional statements don't need braces
         */</span>
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><span style="color: #339933;">!</span>name<span style="color: #009900;">&#41;</span>
                g_assert_not_reached <span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&#160;
        <span style="color: #808080; font-style: italic;">/*
         * More complex ones require braces even if only one of the cases
         * is complex. Note that else if and their condition must be on their
         * own line.
         */</span>
        <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span>name <span style="color: #009900;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">==</span> <span style="color: #ff0000;">'a'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                <span style="color: #b1b100;">return</span> handle_a_type <span style="color: #009900;">&#40;</span>name<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span> <span style="color: #b1b100;">else</span> <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span>name <span style="color: #009900;">&#91;</span><span style="color: #0000dd;">0</span><span style="color: #009900;">&#93;</span> <span style="color: #339933;">==</span> <span style="color: #ff0000;">'b'</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                <span style="color: #b1b100;">return</span> handle_b_type <span style="color: #009900;">&#40;</span>name<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
        <span style="color: #009900;">&#125;</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">&#123;</span>
                <span style="color: #b1b100;">if</span> <span style="color: #009900;">&#40;</span><a href="http://www.opengroup.org/onlinepubs/009695399/functions/strlen.html"><span style="color: #000066;">strlen</span></a> <span style="color: #009900;">&#40;</span>name<span style="color: #009900;">&#41;</span> <span style="color: #339933;">&gt;</span> <span style="color: #0000dd;">1</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                        <span style="color: #808080; font-style: italic;">/* case statements are not indented wrt switch */</span>
                        <span style="color: #b1b100;">switch</span> <span style="color: #009900;">&#40;</span>name <span style="color: #009900;">&#91;</span><span style="color: #0000dd;">1</span><span style="color: #009900;">&#93;</span><span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
                        <span style="color: #b1b100;">case</span> <span style="color: #ff0000;">'S'</span><span style="color: #339933;">:</span>
                                <span style="color: #b1b100;">return</span> handle_s_name <span style="color: #009900;">&#40;</span>name<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                        <span style="color: #b1b100;">case</span> <span style="color: #ff0000;">'C'</span><span style="color: #339933;">:</span>
                        <span style="color: #b1b100;">default</span><span style="color: #339933;">:</span>
                                <span style="color: #b1b100;">return</span> handle_long_name <span style="color: #009900;">&#40;</span>name<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                        <span style="color: #009900;">&#125;</span>
                <span style="color: #009900;">&#125;</span> <span style="color: #b1b100;">else</span> <span style="color: #009900;">&#123;</span>
                        return_type <span style="color: #339933;">=</span> handle_simple_name <span style="color: #009900;">&#40;</span>name<span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
                <span style="color: #009900;">&#125;</span>
        <span style="color: #009900;">&#125;</span>
&#160;
        <span style="color: #808080; font-style: italic;">/* 
         * never use parenthesis with return unless strictly necessary to
         * force precedence rules in complex expressions.
         */</span>
        <span style="color: #b1b100;">return</span> return_type<span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre>
<h2> <span class="mw-headline" id="Testing_changes"> Testing changes </span></h2>
<p>When you make a change to the runtime there are some basic tests that you should run before committing. These tests take just a couple of minutes so they should be run even after small changes.
</p>
<pre> make rcheck in mono/mono/mini
 make test in mono/mono/tests
 make run-test in mcs/class/corlib
</pre>
<p>When doing more significant changes a full bootstrapping build must be
completed (make clean;make in the toplevel mono directory) followed by a make check (which performs the above checks).
</p><p>If possible do this in at least 2 architectures, especially in the cases that involve changing architecture-specific code or check that the buildbot doesn't report regressions after your changes (see 
<a href="http://wrench.mono-project.com/builds" class="external text" rel="nofollow">Mono buildbot</a>).
</p><p>We should try to always add a test case for bugs we're fixing, either in the runtime tests or as a nunit test case.
</p>
<h2> <span class="mw-headline" id="Profiling_and_statistics"> Profiling and statistics </span></h2>
<p>While working on the runtime it's important to pay attention to performance issues and memory usage. There are a number of helper tools we can use to track
data about this.
For a number of important data structures used in the runtime we collect statistics: to get them simply execute your mono programs with:
</p>
<pre> mono --stats program.exe
</pre>
<p>When working on the JIT, compile times are extremely important: we should try to
improve the speed at which we compile code and never cause a slowdown. To be able to check compilation speed you can use a few sample assemblies like mscorlib.dll, System.dll, mcs.exe and JIT compile all the methods in them with:
</p>
<pre> time mono --compile-all assembly.dll
</pre>
<p>checking the results of the time command.
</p><p>When a performance issue becomes appaent given a benchmark or test program, the best tool to use is the mono internal statistical profiler. Use a
high-frequency timer, like the Linux RTC at 1024 Hz and run your command as:
</p>
<pre> echo 1024 &gt; /proc/sys/dev/rtc/max-user-freq
 MONO_RTC=4096 mono --profiler=default:stat program.exe
</pre>
<p>Memory allocations in the runtime should be tracked too from time to time and
special attention must be made to leaks and memory corruption issues. The best tool for this is to use valgrind with commands like:
</p>
<pre> export G_DEBUG=gc-friendly
 export G_SLICE=always-malloc
 valgrind --show-reachable=yes --leak-check=full --leak-resolution=high \
   --error-limit=no --num-callers=8 --suppressions=~/svn/mono/data/mono.supp \
   mono program.exe
</pre>
<h2> <span class="mw-headline" id="Runtime_areas_and_their_maintainers"> Runtime areas and their maintainers </span></h2>
<p>Here is a list of each different chunk of code in the runtime with its respective maintainer or maintainers. Make sure you consult with the appropriate
maintainer before making and especially committing changes to an area that you don't maintain directly (and try always to use the mailing list for communications, so we have a record of decisions and arguments and more people can partecipate and provide their feedback).
</p><p>JIT:
</p>
<ul><li> Overall architecture and anything not explicitly listed: lupus, zoltan
</li><li> x86/amd64 ports: lupus, zoltan
</li><li> ppc/arm ports: lupus
</li><li> sparc/itanium ports: zoltan
</li><li> SSA framework and optimizations: massi
</li><li> aliasing code: massi
</li><li> trampolines: zoltan, lupus
</li><li> local register allocator: zoltan, lupus
</li><li> global register allocator: zoltan, lupus, massi
</li><li> OSX support: lupus
</li><li> solaris/windows support: zoltan
</li><li> exception support: zoltan, lupus
</li><li> genmdesc: lupus
</li><li> security: lupus, sebastien
</li><li> debug code: martin, lupus
</li><li> instruction selector: lupus, zoltan
</li><li> AOT support: zoltan, lupus
</li><li> generics: lupus
</li><li> profiling: lupus
</li></ul>
<p>Runtime:
</p>
<ul><li> Overall architecture and anything not explicitly listed: lupus, zoltan
</li><li> Boehm GC: lupus, zoltan
</li><li> GC interface: lupus
</li><li> SGen GC: lupus
</li><li> GC handles and finalizations: lupus, zoltan
</li><li> Appdomain unload: zoltan, lupus
</li><li> appdomain support: lupus, zoltan
</li><li> metadata loader: lupus, zoltan
</li><li> generics: harinath, lupus, martin
</li><li> debug: martin, lupus
</li><li> reflection: lupus, zoltan
</li><li> reflection.emit: lupus, zoltan
</li><li> dynamic methods: zoltan, lupus
</li><li> verifier: rodrigo
</li><li> marshal, p/invoke support: zoltan, lupus
</li><li> COM support: jchambers
</li><li> security: sebastien, lupus
</li><li> locales: atsushi, lupus, jackson
</li><li> file-io, socket, process: dick
</li><li> console: jeff, dick
</li><li> monitor/lock: lupus, dick
</li><li> config file: lupus
</li><li> profiler: lupus
</li><li> profiler interface: lupus
</li><li> threadpool: lupus
</li><li> thread support: dick, lupus
</li><li> JITInfo support: lupus, mark, zoltan
</li><li> shared lib and module loading: lupus
</li><li> virtual memory allocation: lupus
</li><li> generated code memory handling: lupus, zoltan, mark
</li><li> io-layer: dick
</li></ul>

