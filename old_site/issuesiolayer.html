---
layout: obsolete
title: "IssuesIOLayer"
permalink: /old_site/IssuesIOLayer/
redirect_from:
  - /IssuesIOLayer/
---

<h1>IssuesIOLayer</h1>

<p>This page documents some of the issues with the IO-Layer for use in embedded devices.
</p><p>One of the issues that people might run into with embedded devices and Mono is that the io-layer implementation by default uses shared memory to implement some of its functionality and falls back to private mappings otherwise.
</p><p>The shared memory is used to keep track of information that must be made available to other Mono processes.  It is a rare feature, but one that certain applications depend on (cross process mutexes, events, and other handles). 
</p><p>Shared information like thread handles is kept in this page and this page can grow up to NNN megabytes.
</p>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Disabling_SHM_features"><span class="tocnumber">1</span> <span class="toctext">Disabling SHM features</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Needs:_Test_Suite_for_IO-Layer"><span class="tocnumber">2</span> <span class="toctext">Needs: Test Suite for IO-Layer</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#Questions_for_Dick"><span class="tocnumber">3</span> <span class="toctext">Questions for Dick</span></a></li>
<li class="toclevel-1 tocsection-4"><a href="#Request"><span class="tocnumber">4</span> <span class="toctext">Request</span></a>
<ul>
<li class="toclevel-2 tocsection-5"><a href="#Documentation"><span class="tocnumber">4.1</span> <span class="toctext">Documentation</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Timeouts"><span class="tocnumber">4.2</span> <span class="toctext">Timeouts</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Tuning_of_the_non-SHM_case"><span class="tocnumber">4.3</span> <span class="toctext">Tuning of the non-SHM case</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Tuning_for_embedded_systems"><span class="tocnumber">4.4</span> <span class="toctext">Tuning for embedded systems</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#Challenges_for_Embedded_Systems"><span class="tocnumber">4.5</span> <span class="toctext">Challenges for Embedded Systems</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#Proposals"><span class="tocnumber">5</span> <span class="toctext">Proposals</span></a>
<ul>
<li class="toclevel-2 tocsection-11"><a href="#Process_ID_storage"><span class="tocnumber">5.1</span> <span class="toctext">Process ID storage</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#Reducing_the_size_of_the_table"><span class="tocnumber">5.2</span> <span class="toctext">Reducing the size of the table</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#Mono_Modes"><span class="tocnumber">5.3</span> <span class="toctext">Mono Modes</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#write.2C_read_operations"><span class="tocnumber">5.4</span> <span class="toctext">_write, _read operations</span></a></li>
</ul>
</li>
</ul>
</td></tr></table>
<h1> <span class="mw-headline" id="Disabling_SHM_features"> Disabling SHM features </span></h1>
<p>Mono supports running without the SHM features enabled, but some of its features are disabled in that case.   
</p>
<h1> <span class="mw-headline" id="Needs:_Test_Suite_for_IO-Layer"> Needs: Test Suite for IO-Layer </span></h1>
<p>We need a complete test suite to exercise the various features that the io-layer exposes with the shared memory to understand what exactly stops working in the SHM-less setup, but also to ensure that we do not introduce regressions over time on it.
</p><p>This test suite does not exist today.
</p>
<h1> <span class="mw-headline" id="Questions_for_Dick"> Questions for Dick </span></h1>
<p>If waiting for another process is something that is no longer supported, why do we have processes listed on the shared memory table?
</p><p>Could we reduce the size of the table if we decided to remove by default support for the file sharing/file modes information?
</p>
<h1> <span class="mw-headline" id="Request"> Request </span></h1>
<h2> <span class="mw-headline" id="Documentation"> Documentation </span></h2>
<p>Our <a href="{{site.baseurl}}/Article:IOChanges" title="Article:IOChanges">Documentation</a> needs to be improved:
</p>
<ul><li> The documentation is based on some conversations with Dick.
</li><li> It is not up-to-date.
</li><li> It needs more technical information than it has today
</li><li> Copy-pasting from the mono/docs there is fine.
</li></ul>
<h2> <span class="mw-headline" id="Timeouts"> Timeouts </span></h2>
<p>We currently have a system that basically wakes up Mono every N milliseconds to ensure that we can implement Interrupt/Abort, and this seems suboptimal.
</p><p>I got the impression that we could use a signal, and the signal should interrupt the pthread primitives and that would be all that we need.  Why can we not do this?
</p>
<h2> <span class="mw-headline" id="Tuning_of_the_non-SHM_case"> Tuning of the non-SHM case </span></h2>
<p>If the SHM is disable, we should work without allocating a large table, this would help for example the embedded system case.
</p>
<h2> <span class="mw-headline" id="Tuning_for_embedded_systems"> Tuning for embedded systems </span></h2>
<h2> <span class="mw-headline" id="Challenges_for_Embedded_Systems"> Challenges for Embedded Systems </span></h2>
<p>Flash file systems do not allow the MAP_SHARED flag to share memory in the first place.  
</p><p>On embedded systems we end up allocating the whole table to with MAP_PRIVATE (Nokia) which is wasteful.
</p><p>We could fall back on those devices to use SysV shared memory (there is the chance of collisions).
</p>
<h1> <span class="mw-headline" id="Proposals"> Proposals </span></h1>
<h3> <span class="mw-headline" id="Process_ID_storage"> Process ID storage </span></h3>
<p>When mono exists, it could store the exit code in the ~/.wapi directory in a special file (probably deal with stale files).
</p><p>This was discussed at the Boston 2006 Mono Summit.
</p>
<h3> <span class="mw-headline" id="Reducing_the_size_of_the_table"> Reducing the size of the table </span></h3>
<p>For embedded applications, the need for some of the shared features is probably not necessary.
</p>
<h3> <span class="mw-headline" id="Mono_Modes"> Mono Modes </span></h3>
<p>Maybe have two Mono Modes: the Windows emulation mode which would allow things like named mutexes, events, threads, file sharing and a Unix-mode, in which none of those Windows-isms are exposed or supported.
</p><p>A more "native" implementation of Mono, which would be lighter in many scenarios.
</p>
<h3> <span class="mw-headline" id="write.2C_read_operations"> _write, _read operations </span></h3>
<p>Handle validation happens in ReadFile, WriteFile, aren't the tests in each one of the _write, _read operations redundant?  Could we remove them?
</p>
