---
layout: obsolete
title: "CoreClrHowTo"
permalink: /old_site/CoreClrHowTo/
---

<h1>CoreClrHowTo</h1>

<p>This <i>how to</i> is intended for people who have read about <b>coreclr</b> on <a href="{{site.baseurl}}/Moonlight2CoreCLR#References" title="Moonlight2CoreCLR">MSDN</a>, 
<a href="{{site.baseurl}}/Moonlight2CoreCLR#References" title="Moonlight2CoreCLR">MS employees blogs</a>, Mono's <a href="{{site.baseurl}}/Moonlight2CoreCLR" title="Moonlight2CoreCLR">wiki</a> and how this applies
to <a href="{{site.baseurl}}/Moonlight" title="Moonlight">Moonlight</a>. Once the concepts are understood then you're ready to learn <i>how to</i> enable this feature for your own needs.
</p><p>So what's needed&#160;? Simply a host (full trusted), some platform assemblies (partially trusted code) and applications (untrusted).
</p>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Host"><span class="tocnumber">1</span> <span class="toctext">Host</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Examples"><span class="tocnumber">1.1</span> <span class="toctext">Examples</span></a>
<ul>
<li class="toclevel-3 tocsection-3"><a href="#Mono"><span class="tocnumber">1.1.1</span> <span class="toctext">Mono</span></a></li>
<li class="toclevel-3 tocsection-4"><a href="#Moonlight"><span class="tocnumber">1.1.2</span> <span class="toctext">Moonlight</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-5"><a href="#Platform_Assemblies"><span class="tocnumber">2</span> <span class="toctext">Platform Assemblies</span></a>
<ul>
<li class="toclevel-2 tocsection-6"><a href="#Profiles"><span class="tocnumber">2.1</span> <span class="toctext">Profiles</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-7"><a href="#Applications"><span class="tocnumber">3</span> <span class="toctext">Applications</span></a></li>
<li class="toclevel-1 tocsection-8"><a href="#Advanced"><span class="tocnumber">4</span> <span class="toctext">Advanced</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="#Policies"><span class="tocnumber">4.1</span> <span class="toctext">Policies</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#FAQ"><span class="tocnumber">5</span> <span class="toctext">FAQ</span></a></li>
</ul>
</td></tr></table>
<h1> <span class="mw-headline" id="Host"> Host </span></h1>
<p>Hosting sounds scary&#160;? It's not, at least <b>coreclr</b>-wise and it is likely your simplest step.
</p>
<ol><li> <a href="{{site.baseurl}}/Embedding_Mono" title="Embedding Mono">Embed Mono</a> into your application;
</li><li> Enable CoreCLR (which also enables the verifier) with a call to <b>mono_security_enable_core_clr</b>; and
</li><li> Provide your own callback to <b>mono_security_set_core_clr_platform_callback</b> to determine if an assembly is to be considered as platform code (return <b>TRUE</b>) or not (return <b>FALSE</b>).
</li></ol>
<pre>static gboolean
is_platform_code (const char *image_name)
{
   // insert your own logic, returning TRUE
   // will allow everything as platform code
   return TRUE;
}

void enable_core_clr ()
{
   mono_security_enable_core_clr ();
   mono_security_set_core_clr_platform_callback (is_platform_code);
}
</pre>
<p>However the usefulness of a <b>coreclr</b> host is limited by your own platform assemblies (just like a JIT would not be helpful without class libraries) and your applications.
Also keep in mind that access to some features (e.g. cross-domain web access, sockets...) are not related to <b>coreclr</b>.
</p>
<h2> <span class="mw-headline" id="Examples"> Examples </span></h2>
<p>You can find both a very (i.e. too) simple and very (i.e. totally) complete samples in Mono's GIT repositories.
</p>
<h3> <span class="mw-headline" id="Mono"> Mono </span></h3>
<p>If you look at <b>mono</b> command-line options (i.e. 'man mono') you'll notice a <b>--security</b> option that accept a <b>core-clr</b> parameter.
So it's there (feature wise) and it's not (what you likely want).
Still you can see <b>coreclr</b> being enabled in <a href="https://github.com/mono/mono/raw/master/mono/mini/driver.c" class="external text" rel="nofollow">driver.c</a> and 
the default platform code detection, allowing only <b>mscorlib.dll</b>, in 
<a href="https://github.com/mono/mono/blob/master/mono/metadata/security-core-clr.c" class="external text" rel="nofollow">security-core-clr.c</a>.
</p><p>This means <b>mscorlib.dll</b> is the only assembly that can do <b>critical</b> stuff (and that includes defining <b>safe critical</b> methods).
You can guess that this is severely limited with the default framework profiles.
Remember that no FX profile, even 4.0, is designed to work with <b>only</b> coreclr/transparency.
</p><p>As such this host, unless you provide your own <b>mscorlib.dll</b> or wish to hack a custom mono, is not really usable in real-life scenarios.
However it does show that creating a host and enabled coreclr are not difficult tasks.
Also this <b>mono</b> option is very useful to test the runtime under coreclr (e.g. it's used daily for running fuzz-ed code).
</p>
<h3> <span class="mw-headline" id="Moonlight"> Moonlight </span></h3>
<p><a href="{{site.baseurl}}/Moonlight" title="Moonlight">Moonlight</a>, Mono's open source Silverlight implemention, is a complete, real-life and usable, <b>coreclr</b> host.
</p><p>Being a web browser plugin this may looks like a very different hosting scenario - and it is in many cases. 
But from a <b>coreclr</b> point of view things are very similar the earlier, generic code sample.
</p><p>In the following <a href="https://github.com/mono/moon/raw/master/src/security.cpp" class="external text" rel="nofollow">source code</a> you can see:
</p>
<ol><li> <b>coreclr</b> being enabled; and
</li><li> platform assemblies being defined as specific assembly names inside a specific directory under the plugin installation directory;
</li></ol>
<p>Note that this is the most complete <i>sample</i> you can get and it comes with a set of platform assemblies that is being periodically 
<a href="https://github.com/mono/moon/tree/master/class/tuning/SecurityAttributes/audit" class="external text" rel="nofollow">audited</a>.
</p><p><br />
</p>
<h1> <span class="mw-headline" id="Platform_Assemblies"> Platform Assemblies </span></h1>
<p>The usefulness of any platform is what it allow you to do.
This is why <b>mono</b> as a host is very not useful (with the existing profiles) while Moonlight is for web applications.
</p><p>But what are they&#160;? Simply they are the only assemblies that can do <b>critical</b> operations, e.g. unsafe code, pinvoke...
so this is where you'll end up providing <b>safe</b> conduits to <b>critical</b> operations, policy decisions...
</p><p>Note that all platform assemblies are running under <b>partial</b> trust. This means that <b>all code is transparent</b> (untrusted) 
unless it is decorated with either [SecurityCritical] or [SecuritySafeCritical] attributes.
</p>
<h3> <span class="mw-headline" id="Profiles"> Profiles </span></h3>
<p>So what kind of profile should/can be provided&#160;? Here's a few, simple to complex, suggestions:
</p>
<ol><li> Use the Moonlight profile <i>as-is</i>. It is well tested, supported and <a href="https://github.com/mono/moon/tree/master/class/tuning/SecurityAttributes/audit" class="external text" rel="nofollow">audited</a>;
</li><li> Use a <b>subset</b> of Moonlight. With a little extra work you can all the benefits of the above and a smaller footprint (which likely improves your security since it reduce the surface); or
</li><li> Define your own profile from scratch. You're not totally on your own since Moonlight provides several <a href="https://github.com/mono/moon/tree/master/class/tuning/SecurityAttributes/" class="external text" rel="nofollow">tools</a> and <a href="{{site.baseurl}}/SecurityValidation" title="SecurityValidation">guidance</a>. However this can be a huge undertaking since you'll need to ensure your profile is secure and does not open doors that would circumvent <b>coreclr</b>.
</li></ol>
<p><br />
</p>
<h1> <span class="mw-headline" id="Applications"> Applications </span></h1>
<p>This is the user, untrusted, code on which <b>coreclr</b> will enforce the transparency model. 
No compromise, from the <b>verifier</b> then <b>coreclr</b>, will be made. 
Note that [SecurityCritical] or [SecuritySafeCritical] attributes will be <b>ignored</b> inside application code.
</p><p>Any failure to provide the right attributes (or policies) from platform code can lead to vulnerabilities.
</p><p><br />
</p>
<h1> <span class="mw-headline" id="Advanced"> Advanced </span></h1>
<p>The above describe how the transparency model is applied in <b>coreclr</b>. 
However it's hard to define a complete, useful profile using only attributes that allow/disallow code execution.
</p>
<h2> <span class="mw-headline" id="Policies"> Policies </span></h2>
<p>How can <b>coreclr</b> be used to allow opening TCP sockets between 4502-4534&#160;?
</p><p>Short answer: it cannot.
</p><p>Long answer: Such checks are done by code based on policies (not coreclr). This means the socket code must be transparent (or safe critical)
and provide it's own policy decision (e.g. a range check on the requested port). While <a href="{{site.baseurl}}/CAS" title="CAS">CAS</a> allowed complex policies to be defined, the one
used by <a href="{{site.baseurl}}/Moonlight" title="Moonlight">Moonlight</a> are more strictly defined (e.g. TCP and a subset between 4502-4534). 
Of course your own host can define it's own policy.
</p><p>Policy-driven examples (from Moonlight):
</p>
<ul><li> socket port restrictions
</li><li> cross domain restrictions (scheme, ports, ...)
</li></ul>
<p><br />
</p>
<h1> <span class="mw-headline" id="FAQ"> FAQ </span></h1>
<p>Q: Is CoreCLR new in [Moon|Silver]light 2+&#160;?
</p><p>A: Somewhat. CoreCLR is heavily based on the transparency model which was introduced in .NET 2.0. 
However in the <i>regular</i> framework the transparency model is used in conjunction with <a href="{{site.baseurl}}/CAS" title="CAS">CAS</a> (and the later is not supported on Mono).
</p><p>Q: Does CoreCLR provides all the security for [Moon|Silver]light&#160;?
</p><p>A: Not quite. It's a bit like saying "CAS == stack walk". Stack walks are an important part of <a href="{{site.baseurl}}/CAS" title="CAS">CAS</a> but, without all the other parts,
would not provide any security. In this case <b>coreclr</b> enforce the security attributes in the platform code (along with a few other rules)
but some other features are policy-based (e.g. cross-domain web access, socket support...)
</p>
