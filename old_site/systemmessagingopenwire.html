---
layout: obsolete
title: "SystemMessagingOpenwire"
permalink: /old_site/SystemMessagingOpenwire/
redirect_from:
  - /SystemMessagingOpenwire/
---

<h1>SystemMessagingOpenwire</h1>

<p><br />
At this point Mono has alpha support for the System.Messaging namespace, current (as of release 2.4.2.1) Mono uses <a href="http://www.amqp.org" class="external text" rel="nofollow">AMQP</a> through <a href="http://www.rabbitmq.com" class="external text" rel="nofollow">RabbitMQ</a> to partially implement the messaging APIs.
</p><p>Some consideration has been given to create a shared substrate that could be used by both an open source EnterpriseServices and an Indigo implementation, but little or no code has been produced.
</p><p>The following design document is from Atsushi Enomoto.
</p><p>You might also be interested in <a href="{{site.baseurl}}/Transactions" title="Transactions">transaction processing in Mono</a>.
</p>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Implementing_System.Messaging.dll_over_ActiveMQ_OpenWire.NET"><span class="tocnumber">1</span> <span class="toctext">Implementing System.Messaging.dll over ActiveMQ OpenWire.NET</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Abstract"><span class="tocnumber">1.1</span> <span class="toctext">Abstract</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Build"><span class="tocnumber">1.2</span> <span class="toctext">Build</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#MSMQ_Concepts"><span class="tocnumber">1.3</span> <span class="toctext">MSMQ Concepts</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="#MessageQueue"><span class="tocnumber">1.3.1</span> <span class="toctext">MessageQueue</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#IMessageFormatter"><span class="tocnumber">1.3.2</span> <span class="toctext">IMessageFormatter</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-7"><a href="#OpenWire_Concepts"><span class="tocnumber">1.4</span> <span class="toctext">OpenWire Concepts</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Concerns"><span class="tocnumber">1.5</span> <span class="toctext">Concerns</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#Sample_System.Messaging_code"><span class="tocnumber">1.6</span> <span class="toctext">Sample System.Messaging code</span></a></li>
</ul>
</li>
</ul>
</td></tr></table>
<h1> <span class="mw-headline" id="Implementing_System.Messaging.dll_over_ActiveMQ_OpenWire.NET"> Implementing System.Messaging.dll over ActiveMQ OpenWire.NET </span></h1>
<h2> <span class="mw-headline" id="Abstract"> Abstract </span></h2>
<p>This document explains how I am planning to implement System.Messaging.dll on top of OpenWire.NET (OpenWire.Client.dll) in ActiveMQ project ( <a href="http://www.activemq.org/" class="external free" rel="nofollow">http://www.activemq.org/</a> ).
</p><p>ActiveMQ is part of Apache Geronimo project, an open source J2EE implementation from Apache Software Foundation. It could be understood as an open source implementation of JMS (Java Messaging Services). It also supports native messaging protocol called OpenWire. They provide C# and C clients other than Java, though still in development.
</p><p>Actually any message queueing systems that support OpenWire could be a background service (though it is not likely to happen on other messaging services at least sooner).
</p><p>ActiveMQ supports transactions (of course it does not support MSDTC though), acknowledgement types (though I'm unaware about how equivalent/different AMQ ack and MSMQ ack are), journal queue, and some other required features to support System.Messaging functionality.
</p><p><br />
</p>
<h2> <span class="mw-headline" id="Build"> Build </span></h2>
<p>OpenWire.Client is fairly unstable, so it is very likely to not work
fine.
</p>
<ul><li> Get ActiveMQ from here: <a href="http://activemq.codehaus.org/Download" class="external free" rel="nofollow">http://activemq.codehaus.org/Download</a>   I'm not sure which version strictly works. I used the latest   snapshot.
</li><li> Get the OpenWire.Client snapshot and some required files:
</li></ul>
<pre><a href="http://monkey.workarea.jp/tmp/2006/OpenWire.Client.mcs.tar.bz2" class="external free" rel="nofollow">http://monkey.workarea.jp/tmp/2006/OpenWire.Client.mcs.tar.bz2</a> 
</pre>
<p>To keep it updated, just svn up. And then, run "make dll-sources" which will update OpenWire.Client.dll.sources.
</p>
<ul><li> Extract the above under mcs/class.
</li><li> Add the above directory in mcs/class/Makefile, or build and install  it manually.
</li><li> get and apply the patch for mcs/class/System.Messaging: <a href="http://monkey.workarea.jp/tmp/2006/system.messaging-x-openwire.patch" class="external free" rel="nofollow">http://monkey.workarea.jp/tmp/2006/system.messaging-x-openwire.patch</a>
</li></ul>
<p>Samples are on the bottom of this text.
</p>
<h2> <span class="mw-headline" id="MSMQ_Concepts"> MSMQ Concepts </span></h2>
<p>There are some importatnt concepts in System.Messaging (MSMQ):
</p>
<ul><li> MessageQueue&#160;: A message queue manages a set of Messages.   
</li></ul>
<p>It can represent either a local queue or a remote queue.   MessageQueue is identified by a "Path".   It could be part of a Transaction.  This class also contains several static members to control   MessageQueue manipulation such as creation, existence check or   removal of a queue.
</p>
<ul><li> MessageQueueEnumerator: It enumerates a list of available queues.  
</li></ul>
<p>MS.NET uses MSMQ API to iterate the list, but it seems making a   "snapshot" of the list. When Active Directory is enabled,  MessageQueue.GetMessageQueueEnumerator() seems to return a   meaningful set of MessageQueues (on my box without Active Directory  it always raises MessageQueueException so I cannot verify the   behavior).
</p>
<ul><li> IMessageFormatter: MSMQ messages are formatted into a Stream using an implementation of this interface, such as
<ul><li> XmlMessageFormatter: uses XmlSerializer
</li><li> BinaryMessageFormatter: uses binary serialization formatter
</li><li> ActiveXMessageFormatter: uses ActiveX.
</li></ul>
</li></ul>
<p>It is independent of the background messaging services, except that ActiveXMessageFormatter will never be supported by Mono by its nature.
</p>
<ul><li> Message: It represents a message as you expect. It holds several   fields that controls how to deliver it or how it was delivered.
</li></ul>
<h3> <span class="mw-headline" id="MessageQueue"> MessageQueue </span></h3>
<p>Path can be either 1)FormatName, 2)Label or 3)a set of a MachineName, a QueueName and optionally a kind (Private$, Journal$, DeadLetter$ or XactDeadLetter$).
</p>
<h3> <span class="mw-headline" id="IMessageFormatter"> IMessageFormatter </span></h3>
<p>IMessageFormatter is used for serializing object into a stream (Message.BodyStream). The design principle of System.Messaging is not clear, since for example XmlMessageFormatter.Write() replaces BodyStream instance in its egoistic way.
</p><p><br />
</p>
<h2> <span class="mw-headline" id="OpenWire_Concepts"> OpenWire Concepts </span></h2>
<p>OpenWire of course has different concepts than System.Messaging and MSMQ:
</p><p>- Broker: It represents a message queue host, so it is like an MSMQ service instance. A list of Brokers could consist of MessageQueueEnumerator.
</p><p>- OpenWire protocol is a set of message commands sent between a broker and a client. For example, even to establish a connection, a client sends "ConnectionInfo" to a broker and then waits for the correlated reply.
</p><p>- ConnectionFactory: It is used to create connections and transports. Each ConnectionFactory instance holds a host name and a port number to create ITransport, and a user name, a password and a connection ID to create ConnectionInfo.
</p><p>By default, ConnectionFactory creates a SocketTransport and it  connects to localhost:61616 which is default setting of ActiveMQ services.
</p><p>- Connection: A connection holds a set of Sessions, a Transacted flag, an AcknowledgementMode, ITransport and ConnectionInfo. It can request Commands, but typical users would use MessageConsumer or MessageProducer.
</p><p><br />
</p>
<h2> <span class="mw-headline" id="Concerns"> Concerns </span></h2>
<p>OpenWire.NET itself is in very early stage.
</p><p>There are many implementation differences between MSMQ and ActiveMQ (and/or possible OpenWire protocol implementations).
</p><p>So far I noticed:
</p>
<ul><li> In ActiveMQ message queues are automatically created while it must be explicitly created in MSMQ.
</li><li> System.Messaging.MessageQueue.Receive() keeps waiting for a message until anyone sends a message to the queue. With ActiveMQ, OpenWire.Client.MessageConsumer.Receive() immediately raises an error if there is no message in the queue (though it rather looks like coding matter in OpenWire.Client).
</li></ul>
<p><br />
</p>
<h2> <span class="mw-headline" id="Sample_System.Messaging_code"> Sample System.Messaging code </span></h2>
<p>Send:
</p>
<pre class="csharp" style="font-family:monospace;">        <span style="color: #6666cc; font-weight: bold;">string</span> path <span style="color: #008000;">=</span> <span style="color: #666666;">&quot;.<span style="color: #008080; font-weight: bold;">\\</span>Private$<span style="color: #008080; font-weight: bold;">\\</span>EnoQueue&quot;</span><span style="color: #008000;">;</span>
        <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">!</span>MessageQueue<span style="color: #008000;">.</span><span style="color: #0000FF;">Exists</span> <span style="color: #008000;">&#40;</span>path<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
                MessageQueue<span style="color: #008000;">.</span><span style="color: #0000FF;">Create</span> <span style="color: #008000;">&#40;</span>path<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
        MessageQueue q <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> MessageQueue <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;.<span style="color: #008080; font-weight: bold;">\\</span>Private$<span style="color: #008080; font-weight: bold;">\\</span>EnoQueue&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
        q<span style="color: #008000;">.</span><span style="color: #0000FF;">Send</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;Hola&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></pre>
<p>Receive:
</p>
<pre class="csharp" style="font-family:monospace;">        <span style="color: #6666cc; font-weight: bold;">string</span> path <span style="color: #008000;">=</span> <span style="color: #666666;">&quot;.<span style="color: #008080; font-weight: bold;">\\</span>Private$<span style="color: #008080; font-weight: bold;">\\</span>EnoQueue&quot;</span><span style="color: #008000;">;</span>
        <span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">!</span>MessageQueue<span style="color: #008000;">.</span><span style="color: #0000FF;">Exists</span> <span style="color: #008000;">&#40;</span>path<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
                MessageQueue<span style="color: #008000;">.</span><span style="color: #0000FF;">Create</span> <span style="color: #008000;">&#40;</span>path<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
        MessageQueue q <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> MessageQueue <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;.<span style="color: #008080; font-weight: bold;">\\</span>Private$<span style="color: #008080; font-weight: bold;">\\</span>EnoQueue&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
        Message msg <span style="color: #008000;">=</span> q<span style="color: #008000;">.</span><span style="color: #0000FF;">Receive</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
        XmlMessageFormatter f <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> XmlMessageFormatter <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
        f<span style="color: #008000;">.</span><span style="color: #0000FF;">TargetTypes</span> <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> Type <span style="color: #008000;">&#91;</span><span style="color: #008000;">&#93;</span> <span style="color: #008000;">&#123;</span><a href="http://www.google.com/search?q=typeof+msdn.microsoft.com"><span style="color: #008000;">typeof</span></a> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">&#125;</span><span style="color: #008000;">;</span>
        <span style="color: #6666cc; font-weight: bold;">object</span> o <span style="color: #008000;">=</span> f<span style="color: #008000;">.</span><span style="color: #0000FF;">Read</span> <span style="color: #008000;">&#40;</span>msg<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></pre>

