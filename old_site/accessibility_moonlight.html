---
layout: obsolete
title: "Accessibility: Moonlight"
permalink: /old_site/Accessibility:_Moonlight/
---

<h1>Accessibility: Moonlight</h1>

<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Moonlight_Accessibility"><span class="tocnumber">1</span> <span class="toctext">Moonlight Accessibility</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#For_Developers"><span class="tocnumber">1.1</span> <span class="toctext">For Developers</span></a>
<ul>
<li class="toclevel-3 tocsection-3"><a href="#Building_Firefox_with_Plugin_Accessibility_.28mozilla-1.9.2.29"><span class="tocnumber">1.1.1</span> <span class="toctext">Building Firefox with Plugin Accessibility (mozilla-1.9.2)</span></a></li>
<li class="toclevel-3 tocsection-4"><a href="#Building_Firefox_with_Plugin_Accessibility_.28mozilla-central.29"><span class="tocnumber">1.1.2</span> <span class="toctext">Building Firefox with Plugin Accessibility (mozilla-central)</span></a></li>
<li class="toclevel-3 tocsection-5"><a href="#Useful_notes"><span class="tocnumber">1.1.3</span> <span class="toctext">Useful notes</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#Development_with_Firefox"><span class="tocnumber">1.1.4</span> <span class="toctext">Development with Firefox</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#Setting_up_your_Moonlight_Environment"><span class="tocnumber">1.1.5</span> <span class="toctext">Setting up your Moonlight Environment</span></a>
<ul>
<li class="toclevel-4 tocsection-8"><a href="#Supplies"><span class="tocnumber">1.1.5.1</span> <span class="toctext">Supplies</span></a></li>
<li class="toclevel-4 tocsection-9"><a href="#Setting_up_the_Base_Environment"><span class="tocnumber">1.1.5.2</span> <span class="toctext">Setting up the Base Environment</span></a></li>
<li class="toclevel-4 tocsection-10"><a href="#Building_for_Firefox_.28mozilla-1.9.2.29"><span class="tocnumber">1.1.5.3</span> <span class="toctext">Building for Firefox (mozilla-1.9.2)</span></a></li>
<li class="toclevel-4 tocsection-11"><a href="#Building_for_Firefox_.28mozilla-central.29"><span class="tocnumber">1.1.5.4</span> <span class="toctext">Building for Firefox (mozilla-central)</span></a></li>
<li class="toclevel-4 tocsection-12"><a href="#Useful_notes_2"><span class="tocnumber">1.1.5.5</span> <span class="toctext">Useful notes</span></a></li>
<li class="toclevel-4 tocsection-13"><a href="#Setting_up_the_MoonAtkBridge_Environment_.28mozilla-1.9.2.29"><span class="tocnumber">1.1.5.6</span> <span class="toctext">Setting up the MoonAtkBridge Environment (mozilla-1.9.2)</span></a></li>
<li class="toclevel-4 tocsection-14"><a href="#Setting_up_the_MoonAtkBridge_Environment_.28mozilla-central.29"><span class="tocnumber">1.1.5.7</span> <span class="toctext">Setting up the MoonAtkBridge Environment (mozilla-central)</span></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</td></tr></table>
<h1> <span class="mw-headline" id="Moonlight_Accessibility"> Moonlight Accessibility </span></h1>
<p>As part of their second phase, the Mono Accessibility team will be implementing full UIA support for <a href="{{site.baseurl}}/Moonlight" title="Moonlight">Moonlight</a>.
</p><p>The following platforms will be supported using our plugin:
</p>
<ul><li> SUSE Linux Enterprise Desktop 10
</li><li> openSUSE 11.0
</li><li> openSUSE 11.1
</li><li> openSUSE 11.2
</li><li> SUSE Linux Enterprise Desktop 11
</li><li> Fedora 10
</li><li> Fedora 11
</li><li> Fedora 12
</li><li> Ubuntu 9.04 (Jaunty Jackalope)
</li></ul>
<h2> <span class="mw-headline" id="For_Developers"> For Developers </span></h2>
<p>In order to enable Moonlight Accessibility in Firefox you have to apply a patch, this patch depends on the version of Firefox. We have two patches, one for <i>mozilla-1.9.2</i> and one for <i>mozilla-central</i>. Make sure you are using compatible revisions and patches otherwise Moonlight Accessibility will not compile nor work. 
</p>
<ul><li> <i>mozilla-1.9.2</i> is compatible with <a href="http://github.com/mono/moon/tree/moon/moon-2-0" class="external text" rel="nofollow">Moon 2.0 (branch)</a> and MoonAtkBridge (trunk).
</li><li> <i>mozilla-central</i> is compatible with <a href="http://github.com/mono/moon" class="external text" rel="nofollow">Moon (master)</a> and MoonAtkBridge+patch (trunk).
</li></ul>
<p>Before building Firefox you will need to install the following libraries:
</p>
<ul><li> <a href="http://software.opensuse.org/ymp/mozilla/openSUSE_11.1/autoconf213.ymp" class="external text" rel="nofollow">autoconf 2.13</a>
</li><li> libnotify-devel
</li></ul>
<p>Also you will need to create a .mozconfig file to help you building Firefox, use the following template:
</p>
<pre>
. $topsrcdir/browser/config/mozconfig

ac_add_options --enable-application=browser
mk_add_options MOZ_CO_PROJECT=browser

mk_add_options MOZ_OBJDIR=@TOPSRCDIR@/obj-debug
mk_add_options MOZ_MAKE_FLAGS=-j4

ac_add_options --enable-debug
ac_add_options --disable-optimize
ac_add_options --enable-tests
ac_add_options --disable-crashreporter
ac_add_options --disable-necko-wifi
</pre>
<p>Notice latest patch is tracked in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=480317" class="external text" rel="nofollow">Mozilla Bug #480317</a>
</p>
<h3> <span class="mw-headline" id="Building_Firefox_with_Plugin_Accessibility_.28mozilla-1.9.2.29"> Building Firefox with Plugin Accessibility (mozilla-1.9.2) </span></h3>
<ul><li> <a href="https://developer.mozilla.org/en/Mozilla_Source_Code_(Mercurial)" class="external text" rel="nofollow">Check out</a> Firefox from <i>mozilla-1.9.2 (Firefox 3.6)</i>
</li><li> Apply the latest plugin accessibility patch from <a href="http://github.com/mono/uia2atk/blob/master/MoonAtkBridge/patches/ff-plugin-a11y.patch" class="external text" rel="nofollow">uia2atk/MoonAtkBridge</a>
</li><li> Move your .mozconfig to your checkout folder and build for the first time:
</li></ul>
<pre>make -f client.mk build
</pre>
<ul><li> Then you can continue to <a href="#Building_for_Firefox_.28mozilla-1.9.2.29">#Building for Firefox (mozilla-1.9.2)</a>
</li></ul>
<h3> <span class="mw-headline" id="Building_Firefox_with_Plugin_Accessibility_.28mozilla-central.29"> Building Firefox with Plugin Accessibility (mozilla-central) </span></h3>
<ul><li> <a href="https://developer.mozilla.org/en/Mozilla_Source_Code_(Mercurial)" class="external text" rel="nofollow">Check out</a> Firefox from <i>mozilla-central (Firefox 4.0)</i>
</li><li> Apply the latest plugin accessibility patch from <a href="http://github.com/mono/uia2atk/blob/master/MoonAtkBridge/patches/mozilla-central/ff-plugin-a11y.patch" class="external text" rel="nofollow">uia2atk/MoonAtkBridge</a>
</li><li> Move your .mozconfig to your checkout folder and build for the first time:
</li></ul>
<pre>make -f client.mk build
</pre>
<ul><li> Then you can continue to <a href="#Building_for_Firefox_.28mozilla-central.29">#Building for Firefox (mozilla-central)</a>
</li></ul>
<h3> <span class="mw-headline" id="Useful_notes"> Useful notes </span></h3>
<p>Incremental build is enabled after you build Firefox for the first time. This will allow you to only build what has changed instead of the entire project, saving hours of time.  To use this, simply change directory into <tt>obj-debug/FolderYouChanged</tt> and type make.
</p><p>If I changed something in the <tt>accessible/</tt> directory, I would:
</p>
<pre>cd obj-debug/accessible/
make
</pre>
<h3> <span class="mw-headline" id="Development_with_Firefox"> Development with Firefox </span></h3>
<p>If you find yourself in the position of maintaining a patch against Firefox for a long time, Mercurial can be your best friend.
</p><p>When you get to a good stopping point, <tt>hg commit</tt> your code, and continue working as normal.
</p><p>Sooner or later, you'll have to pull in the latest changes from HEAD into your branch.  To make this easier, enable the Mercurial <tt>rebase</tt> plugin by putting
</p>
<pre>[extensions]
hgext.rebase = 
</pre>
<p>into your <tt>~/.hgrc</tt> file.
</p><p>Now, to update your local repository:
</p>
<pre>brad@blackbird:~/build/firefox-trunk$ <b>hg pull</b>
pulling from <a href="http://hg.mozilla.org/mozilla-central/" class="external free" rel="nofollow">http://hg.mozilla.org/mozilla-central/</a>
searching for changes
adding changesets
adding manifests
adding file changes
added 76 changesets with 276 changes to 228 files (+1 heads)
(run 'hg heads' to see heads, 'hg merge' to merge)
brad@blackbird:~/build/firefox-trunk$ <b>hg rebase</b>
merging accessible/src/atk/Makefile.in
merging accessible/src/base/nsAccessibilityService.cpp
merging accessible/src/base/nsAccessibilityService.cpp
warning: conflicts during merge.
merging accessible/src/base/nsAccessibilityService.cpp failed!
abort: fix unresolved conflicts with hg resolve then run hg rebase --continue
...
  Resolve any conflicts...
...
brad@blackbird:~/build/firefox-trunk$ <b>hg rebase --continue</b>
saving bundle to /home/brad/build/firefox-trunk/.hg/strip-backup/b67e49ad7fa4-temp
adding branch
adding changesets
adding manifests
adding file changes
added 81 changesets with 292 changes to 232 files
rebase completed
brad@blackbird:~/build/firefox-trunk$
</pre>
<h3> <span class="mw-headline" id="Setting_up_your_Moonlight_Environment"> Setting up your Moonlight Environment </span></h3>
<h4> <span class="mw-headline" id="Supplies"> Supplies </span></h4>
<ul><li> A working parallel development environment. See <a href="http://www.mono-project.com/Parallel_Mono_Environments" class="external text" rel="nofollow">Parallel Mono Environments</a> or <a href="http://blog.carrion.mx/2010/01/25/parallel-development-environments-pulque/" class="external text" rel="nofollow">Pulque</a>.
</li><li> Matching versions of <tt>mono</tt>, <tt>mcs</tt>, and <tt>moon</tt> from trunk
</li><li> A checkout of <tt>uia2atk</tt> from trunk
</li><li> Firefox trunk with plugin patch applied (see above)
</li><li> An hour, a <a href="http://icanhascheezburger.com" class="external text" rel="nofollow">good</a> <a href="http://thedailykitten.com/" class="external text" rel="nofollow">build-time</a> <a href="http://youlooknicetoday.com" class="external text" rel="nofollow">distraction</a> and a tall glass of water
</li><li> Notice that you will always have to use your parallel environment when building and installing all modules.
</li></ul>
<h4> <span class="mw-headline" id="Setting_up_the_Base_Environment"> Setting up the Base Environment </span></h4>
<ul><li> Set up a development profile in Firefox
</li></ul>
<pre>firefox -no-remote -ProfileManager
</pre>
<p>Press the <i>Create Profile</i> button.  Set the profile name to <tt>dev</tt> and the path to <tt>~/.mozilla/firefox/profiles-dev</tt>.
</p>
<ul><li> Create an alias to the development version of Firefox
</li></ul>
<pre>alias ffd='$HOME/build/firefox-trunk/obj-debug/dist/bin/firefox -no-remote -P dev'
</pre>
<h4> <span class="mw-headline" id="Building_for_Firefox_.28mozilla-1.9.2.29"> Building for Firefox (mozilla-1.9.2) </span></h4>
<ul><li> Using your parallel development environment (see above) checkout <i>mono</i>, <i>moon</i>, <i>mono-basic</i>, <i>uia2atk</i> and <i>gtk-sharp</i>, use the valid branches:
</li></ul>
<pre>git clone <a href="git://github.com/mono/mono.git" class="external free" rel="nofollow">git://github.com/mono/mono.git</a> &amp;&amp; cd mono &amp;&amp; git branch moon-2-0 origin/moon/moon-2-0 &amp;&amp; git checkout moon-2-0
git clone <a href="git://github.com/mono/moon.git" class="external free" rel="nofollow">git://github.com/mono/moon.git</a> &amp;&amp; cd moon &amp;&amp; git branch moon-2-0 origin/moon/moon-2-0 &amp;&amp; git checkout moon-2-0
git clone <a href="git://github.com/mono/mono-basic.git" class="external free" rel="nofollow">git://github.com/mono/mono-basic.git</a> &amp;&amp; cd mono-basic &amp;&amp; git branch moon-2-0 origin/moon/moon-2-0 &amp;&amp; git checkout moon-2-0
git clone <a href="git://github.com/mono/gtk-sharp.git" class="external free" rel="nofollow">git://github.com/mono/gtk-sharp.git</a> &amp;&amp; cd gtk-sharp &amp;&amp; git branch gtk-sharp-2-12 origin/gtk-sharp-2-12-branch &amp;&amp; git checkout gtk-sharp-2-12
git clone <a href="git://github.com/mono/uia2atk.git" class="external free" rel="nofollow">git://github.com/mono/uia2atk.git</a>
</pre>
<ul><li> Make and install Mono (make sure you are using your parallel environment prefix):
</li></ul>
<pre>cd mono &amp;&amp; ./autogen.sh --prefix=/path/to/my/prefix &amp;&amp; make &amp;&amp; make install
</pre>
<ul><li> Double check your mono version:
</li></ul>
<pre>mono --version
</pre>
<ul><li> It should be something like: <i>Mono JIT compiler version 2.6.1 (tarball rXXXXXX)</i>
</li><li> Make and install gtk-sharp-2-12:
</li></ul>
<pre>cd .../gtk-sharp/ &amp;&amp; ./bootstrap-2.12 --prefix=/path/to/my/prefix &amp;&amp; make &amp;&amp; make install
</pre>
<ul><li> Patch Moonlight:
</li></ul>
<pre>cd ../moon
patch -p 0 &lt; ../uia2atk/MoonAtkBridge/patches/moonlight-a11y-core-extension.diff
patch -p 0 &lt; ../uia2atk/MoonAtkBridge/patches/moonlight-a11y-slot-tree.diff
./autogen.sh --prefix=/path/to/my/prefix --with-mcspath=../mono/mcs 
</pre>
<p>Autogen takes a little bit to run, then make sure that <tt>./autogen.sh</tt>'s output includes something like:
</p>
<pre>
  Silverlight Support:
        Silverlight 1.0: yes
        Silverlight 2.0: yes
          Browser plugin assemblies: yes 
            Path to mcs tree: ./../mcs
            Path to mono-basic tree: ./../mono-basic
          Desktop application assemblies: yes 

  Browser Support:
        Firefox: yes
          Plugin Installer (.xpi): yes
          Gecko 1.8 (Firefox 2): no (reason: missing FF2 development packages)
          Gecko 1.9 (Firefox 3): yes 
          Curl bridge: embedded 
        Chrome (.crx): no (no chrome executable)
</pre>
<p>The most important thing to notice is <b> Plugin Installer (.xpi): yes</b>.
</p>
<ul><li> Build <tt>moon</tt>
</li></ul>
<pre>make &amp;&amp; make install
</pre>
<ul><li> Build <tt>moon</tt> XPI file
</li></ul>
<pre>make user-plugin
</pre>
<ul><li> Install Moon XPI into Firefox
</li></ul>
<pre>ffd plugin/install/novell-moonlight.xpi
</pre>
<ul><li> Then you can continue to <a href="#Setting_up_the_MoonAtkBridge_Environment_.28mozilla-1.9.2.29">#Setting up the MoonAtkBridge Environment (mozilla-1.9.2)</a>
</li></ul>
<h4> <span class="mw-headline" id="Building_for_Firefox_.28mozilla-central.29"> Building for Firefox (mozilla-central) </span></h4>
<ul><li> Checkout <i>gtk-sharp-2-12-branch</i>:
</li></ul>
<pre>git clone <a href="git://github.com/mono/gtk-sharp.git" class="external free" rel="nofollow">git://github.com/mono/gtk-sharp.git</a> &amp;&amp; cd gtk-sharp &amp;&amp; git branch gtk-sharp-2-12 origin/gtk-sharp-2-12-branch &amp;&amp; git checkout gtk-sharp-2-12 
</pre>
<ul><li> Building moon requires its own copy of mcs/mono/mono-basic so make a new directory and change to it:
</li></ul>
<pre>mkdir moon_checkout &amp;&amp; cd moon_checkout
</pre>
<ul><li> Using your parallel development environment (see above) checkout <i>moon</i>:
</li></ul>
<pre>git clone <a href="git://github.com/mono/moon.git" class="external free" rel="nofollow">git://github.com/mono/moon.git</a>
</pre>
<ul><li> Open the README file in moon and look for the section called: <b>Requirements</b>, in that section you will notice the revisions required to build moonlight, for example <i><a href="http://github.com/mono/moon/commit/79a21bf3713bef8832a5c8c04f3c3e4ca84295d6" class="external text" rel="nofollow">moon 79a21b</a></i>:
</li></ul>
<pre>git clone <a href="git://github.com/mono/mono.git" class="external free" rel="nofollow">git://github.com/mono/mono.git</a> mono &amp;&amp; cd mono &amp;&amp; git reset --hard 9c8cb87fe336e678e902 
&amp;&amp; cd .. git clone <a href="git://github.com/mono/mono-basic.git" class="external free" rel="nofollow">git://github.com/mono/mono-basic.git</a> mono-basic &amp;&amp; cd mono-basic &amp;&amp; git reset --hard HEAD
</pre>
<ul><li> Copy the folders to a lower level (you can also checkout the <b>same modules</b> and <b>the same revisions</b>, copying should be faster)
</li></ul>
<pre>cp -r mono ..
cp -r mono-basic ..
cd ..
</pre>
<ul><li> You should have 3 folders in your current working directory:
</li></ul>
<pre>mono  mono-basic  moon_checkout
</pre>
<ul><li> Build and install mono:
</li></ul>
<pre>cd mono &amp;&amp; ./autogen.sh --prefix=/path/to/my/prefix &amp;&amp; make &amp;&amp; make install
</pre>
<ul><li> Double check your mono version:
</li></ul>
<pre>mono --version
</pre>
<ul><li> It should be something like: <i>Mono JIT compiler version 2.7 (rXXXXX)</i>
</li><li> Make and install gtk-sharp-2-12-branch:
</li></ul>
<pre>cd ../gtk-sharp-2-12/ &amp;&amp; ./bootstrap-2.12 --prefix=/path/to/my/prefix &amp;&amp; make &amp;&amp; make install
</pre>
<ul><li> Change to moon_checkout/moon and apply the following patch:
</li></ul>
<pre>cd ../moon_checkout/moon
patch -p0 &lt; ~/path/to/uia2atk/MoonAtkBridge/patches/moon_trunk/moonlight-a11y-core-extension.diff
</pre>
<ul><li> Run autogen.sh:
</li></ul>
<pre>./autogen.sh --prefix=/path/to/my/prefix
</pre>
<p>Autogen takes a while to run, then make sure that <tt>./autogen.sh</tt>'s output includes something like:
</p>
<pre>
  Browser Support:
	Firefox: yes
          Plugin Installer (.xpi): yes
          Gecko 1.8 (Firefox 2): no (reason: missing FF2 development packages)
          Gecko 1.9 (Firefox 3): yes 
	Fallback bridge support:
          Curl bridge: embedded 
        Chrome (.crx): no (no chrome executable)

  Platform abstraction layer:
	Windowing system: gtk (hardcoded)
	Messaging layer: glib+unix (hardcoded)
	NetworkAvailability layer: dbus-glib (hardcoded)
        Capture Service: linux (hardcoded)
	    Video capture backends: v4l2 (hardcoded)
	    Audio capture backends: none (hardcoded)
</pre>
<p>The most important thing to notice is <b> Plugin Installer (.xpi): yes</b>.
</p>
<ul><li> Build <tt>moon</tt>
</li></ul>
<pre>make &amp;&amp; make install
</pre>
<ul><li> Build <tt>moon</tt> XPI file
</li></ul>
<pre>make user-plugin
</pre>
<ul><li> Install Moon XPI into Firefox
</li></ul>
<pre>ffd plugin/install/novell-moonlight.xpi
</pre>
<ul><li> Then you can continue to <a href="#Setting_up_the_MoonAtkBridge_Environment_.28mozilla-central.29">#Setting up the MoonAtkBridge Environment (mozilla-central)</a>
</li></ul>
<h4> <span class="mw-headline" id="Useful_notes_2"> Useful notes </span></h4>
<p>If you're making changes to Moonlight, you'll often have to:
</p>
<pre>make &amp;&amp; rm plugin/install/novell-moonlight.xpi &amp;&amp; make user-plugin
ffd plugin/install/novell-moonlight.xpi
</pre>
<p>Don't forget to update to the revisions specified in the README accordingly.
</p>
<h4> <span class="mw-headline" id="Setting_up_the_MoonAtkBridge_Environment_.28mozilla-1.9.2.29"> Setting up the MoonAtkBridge Environment (mozilla-1.9.2) </span></h4>
<ul><li> MoonAtkBridge requires a <i>moon</i> folder in the same level, make sure the folder exists before compiling MoonAtkBridge
</li><li> Configure and build MoonAtkBridge
</li></ul>
<pre>cd uia2atk/MoonAtkBridge
./autogen.sh --prefix=/path/to/my/prefix
make
</pre>
<p>This will create a <tt>stage/</tt> directory containing all of the files required for a Firefox extension.  We could make and install an XPI right away with <tt>make xpi</tt>, but for development, it's much easier if we just symlink this directory into our Mozilla plugins folder:
</p>
<pre> cd ~/.mozilla/firefox/profiles-dev/extensions/
 ln -s /path/to/uia2atk/MoonAtkBridge/stage moonlight-a11y@novell.com
</pre>
<p>Now, when you run Firefox, our extension should load and you should be able to see a live accessibility hierarchy inside of Accerciser.
</p><p>When developing in MoonAtkBridge, just <tt>make</tt> after you make changes, and re-run Firefox to see the results.
</p>
<h4> <span class="mw-headline" id="Setting_up_the_MoonAtkBridge_Environment_.28mozilla-central.29"> Setting up the MoonAtkBridge Environment (mozilla-central) </span></h4>
<ul><li> MoonAtkBridge requires a <i>moon</i> folder in the same level, so you will have to create a symbolic link to moon_checkout/moon/ first.
</li></ul>
<pre>cd ../.. &amp;&amp; ln -s moon_checkout/moon/ .
</pre>
<ul><li> Patch MoonAtkBridge to enable OOPP:
</li></ul>
<pre>cd uia2atk/
patch -p 1 &lt; MoonAtkBridge/patches/moon_trunk/moonatkbridge-oop.patch
</pre>
<ul><li> Configure and build MoonAtkBridge
</li></ul>
<pre>cd MoonAtkBridge
./autogen.sh --prefix=/path/to/my/prefix
make
</pre>
<p>This will create a <tt>stage/</tt> directory containing all of the files required for a Firefox extension.  We could make and install an XPI right away with <tt>make xpi</tt>, but for development, it's much easier if we just symlink this directory into our Mozilla plugins folder:
</p>
<pre> cd ~/.mozilla/firefox/profiles-dev/extensions/
 ln -s /path/to/uia2atk/MoonAtkBridge/stage moonlight-a11y@novell.com
</pre>
<p>Now, when you run Firefox, our extension should load and you should be able to see a live accessibility hierarchy inside of Accerciser.
</p><p>When developing in MoonAtkBridge, just <tt>make</tt> after you make changes, and re-run Firefox to see the results.
</p>
