---
layout: obsolete
title: "BuildSystem/MonoBuild"
permalink: /old_site/BuildSystem/MonoBuild/
redirect_from:
  - /BuildSystem/MonoBuild/
---

<h1>BuildSystem/MonoBuild</h1>

<p><br />
</p>
<div style="margin-left: auto; padding: 5px; margin-right: auto; background-color: #C6D8ED; border: 1px solid #5084C5; border-left-width: 10px; margin-top: 20px; margin-bottom: 20px;">
<p>MonoBuild is no longer used.  This page here for historical purposes.
</p><p>Current build status is <a href="http://wrench.mono-project.com/builds" class="external text" rel="nofollow">here</a>.
</p>
</div>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Overview"><span class="tocnumber">1</span> <span class="toctext">Overview</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Background"><span class="tocnumber">2</span> <span class="toctext">Background</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#HOWTO"><span class="tocnumber">3</span> <span class="toctext">HOWTO</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#Detailed_documentation"><span class="tocnumber">3.1</span> <span class="toctext">Detailed documentation</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Interacting_with_build_clients"><span class="tocnumber">3.2</span> <span class="toctext">Interacting with build clients</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Shutting_down_monobuild"><span class="tocnumber">3.3</span> <span class="toctext">Shutting down monobuild</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Setting_up_a_new_build_client"><span class="tocnumber">3.4</span> <span class="toctext">Setting up a new build client</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Removing_a_build_client"><span class="tocnumber">3.5</span> <span class="toctext">Removing a build client</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#Add_new_package.2Fmodule_to_MonoBuild"><span class="tocnumber">3.6</span> <span class="toctext">Add new package/module to MonoBuild</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#Configuring_Apache_for_the_MonoBuild_Webview"><span class="tocnumber">3.7</span> <span class="toctext">Configuring Apache for the MonoBuild  Webview</span></a></li>
</ul>
</li>
</ul>
</td></tr></table>
<h1> <span class="mw-headline" id="Overview"> Overview </span></h1>
<p>Monobuild is a tinderbox/buildbot-like system to continually build and run tests and build steps.  It differs from buildbot in that no client it necessary on the build host.  Everything is done from a centralized server and jobs are pushed over ssh.  (Jobs can also be done locally as well).
</p><p>Monobuild also facilitates rpm packaging, although it has an alternate system that stores builds in .zip files for systems that don't use rpm.
</p><p>There is also a set of scripts that will publish released builds to a server and generate some static html pages with links.
</p><p>It is designed around Mono, but there's no reason it couldn't be used for other projects.  Most (possibly all) of the hardcoded configuration is in trunk/release/pyutils/config.py .
</p><p><a href="http://mono.ximian.com/monobuild" class="external text" rel="nofollow">Mono's Monobuild</a>.
</p>
<h1> <span class="mw-headline" id="Background"> Background </span></h1>
<p>Mono used to use buildbot for its' continual build system and Ximian BuildBuddy for doing packaging.  We had issues with buildbot because when client connections were lost, we had to restart the server, which lost all build logs and metadata.  (Monobuild currently has build metadata ranging back to April of 2006).  BuildBuddy worked well enough for packaging, but it was unmaintained after some time, and it was a pain to sync ximian-build.conf files with native .spec files that were submitted to suse autobuild.  We now use only .spec files for building rpms.
</p><p>The original scripts that were written by Ben were all done in Bash.  It was getting harder and kludgier to add features, plus, differing versions of bash behaved differently.  We were starting to build on other unix systems which also made it more difficult to use shell.  This is when it was decided to use python instead.  (Perl was considered since I knew it best, but Duncan was talking about how much better python was over perl, so I decided to give it a shot.  Thank goodness I did&#160;:)
</p>
<h1> <span class="mw-headline" id="HOWTO"> HOWTO </span></h1>
<h2> <span class="mw-headline" id="Detailed_documentation"> Detailed documentation </span></h2>
<p>To see more detailed documentation, check the following link:  <a href="{{site.baseurl}}/BuildSystem/MonoBuild/DetailedDocs" title="BuildSystem/MonoBuild/DetailedDocs">BuildSystem/MonoBuild/DetailedDocs</a>
</p>
<h2> <span class="mw-headline" id="Interacting_with_build_clients"> Interacting with build clients </span></h2>
<p>You can check out some scripts that will allow you to cancel running builds and log into build clients.
</p>
<pre>svn co <a href="svn://anonsvn.mono-project.com/source/trunk/release" class="external free" rel="nofollow">svn://anonsvn.mono-project.com/source/trunk/release</a>
cd release/packaging
</pre>
<p>Running ./jail-do will give a usage of all the methods.
</p><p>To log in:
</p>
<pre>./jail-do sles-9-x86_64
</pre>
<p>To run 'ls':
</p>
<pre>./jail-do sles-9-x86_64 run ls
</pre>
<p>You can also lock the client, check to see if it's locked, unlock it, or interrupt the current job.
</p><p>(Note: a lot of ssh calls are made to do these operations... surely they can be optimized/minimized, so if you start getting tired of typing in the ssh password, ask for the ssh key that will allow you to log in to any of the build clients)
</p><p>You can also lock the clients by placing some files in the appropriate places.  The internal workings may change at some point, so it's probably better to use jail-do.  But if you insist, put these two files in place:
</p>
<pre>touch /tmp/monobuild/locked
touch /tmp/monobuild/interrupted
</pre>
<p>This will keep the scheduler from farming builds to that client.
</p><p>To interrupt the current job manually instead of using jail-do, put the above two files in place, and then run the following on the client:
</p>
<pre>kill -9 -`cat /tmp/monobuild/pgid_kill`
</pre>
<h2> <span class="mw-headline" id="Shutting_down_monobuild"> Shutting down monobuild </span></h2>
<p>In order to shut down monobuild (which is usually done during release time) edit trunk/release/pyutils/config.py and change all _active variables to 'False' instead of 'True'.  This will prevent any additional jobs from being scheduled.
</p>
<h2> <span class="mw-headline" id="Setting_up_a_new_build_client"> Setting up a new build client </span></h2>
<p>For linux, this is done by creating a chroot environment.  Scripts to create this can be found in <a href="svn://anonsvn.mono-project.com/source/trunk/release/jailbuilder" class="external free" rel="nofollow">svn://anonsvn.mono-project.com/source/trunk/release/jailbuilder</a>.  Inside of that chroot env, you must create a user account (typically 'builder') that has non-interactive (meaning you don't need to enter a password) sudo rights.  Python must be installed.
</p><p>For other systems, as well as for linux running in a non-chroot env, you need python and a user account with full sudo rights as described above.
</p>
<h2> <span class="mw-headline" id="Removing_a_build_client"> Removing a build client </span></h2>
<p>After a distribution or OS is no longer maintained it is removed from monobuild.  This keeps the list of distros to a minimum.  Here are the steps to remove a distro:
</p>
<ol><li>Remove packaging/conf/&lt;distro name&gt;
</li><li>Remove references to that distro from all packaging/def files
</li><li>If noarch or $ARCH builds were done on that distro, move all build metadata info (release/monobuild/www/builds/) to the distro that will be replacing this distro.  For $DISTRO def files, the metadata for this distro can safely be removed (note: this step won't be needed once we don't share rpms any longer)
</li></ol>
<p>Note: Snapshot repositories and class status pages are built on certain distros.  (SLE10 at this point).  When those distros go away, these processes need to be configured to use the replacement distros instead.  Also, all references in release/packaging/defs/* need to be replaced as well.
</p><p>To update the class status distros, modify:
</p>
<ul><li>release/monobuild/collect-class-status.py
</li></ul>
<p>To update the snapshot distros, update:
</p>
<ul><li>release/packaging/upload-snapshot
</li></ul>
<h2> <span class="mw-headline" id="Add_new_package.2Fmodule_to_MonoBuild"> Add new package/module to MonoBuild </span></h2>
<p>Create a new file in release/packaging/defs to add a new package.  The .def file is typically named after the svn module name, rpm package, or the tarball name.
</p><p>You can use another .def file as a template as well as refer to the <a href="{{site.baseurl}}/BuildSystem/MonoBuild/DetailedDocs" title="BuildSystem/MonoBuild/DetailedDocs">BuildSystem/MonoBuild/DetailedDocs</a>.
</p><p>The main things to know are:
</p>
<ul><li>svn trunk and tag paths
</li><li>which distros to build on
</li><li>whether the package is noarch or should be shared across distros
</li><li>If the package isn't building on a system that uses rpm, you'll need to fill out the _zip vars
</li><li>For rpm base systems, you'll need a .spec file in release/packaging/rpm_defs/&lt;def file&gt;
</li></ul>
<p>If you want the module to be published with sources and added to the snapshot repositories, you'll need to add your module to the following files:
</p>
<ul><li>release/website/sources-index
</li><li>release/website/distro-index
</li><li>release/website/repo-config/config.py
</li></ul>
<p>If you want the module to automatically be built in monobuild, add it to:
</p>
<ul><li>release/pyutils/config.py
</li></ul>
<p>Make sure that the distros you want it built on are also listed in that file, otherwise the build won't get started.
</p>
<h2> <span class="mw-headline" id="Configuring_Apache_for_the_MonoBuild_Webview"> Configuring Apache for the MonoBuild  Webview </span></h2>
<p>The webview gives a nice dashboard overview of the status of all of the latest builds in the system.  You can see Mono's webview <a href="http://mono.ximian.com/monobuild" class="external text" rel="nofollow">here</a>.
</p><p>To configure the build server you must have mod_python installed.  Here's an example of how to configure a suse 10.2 system.
</p>
<pre>zypper install apache2-mod_python
</pre>
<p>Place these contents in /etc/apache2/conf.d/python.conf
</p>
<pre>
LoadModule python_module /usr/lib64/apache2/mod_python.so

# Override type-map handler for /var/www/manual
&lt;Directory &quot;/var/www/manual/mod/mod_python&quot;&gt;
        &lt;Files *.html&gt;
                SetHandler default-handler
        &lt;/Files&gt;
&lt;/Directory&gt;

#&lt;Directory /www/htdocs/mp&gt;
&lt;Directory /home/wberrier/wa/msvn/release/monobuild/www/python&gt;
        AddHandler mod_python .py
        PythonHandler mod_python.publisher
        #PythonPath ['/home/wberrier/wa/msvn/release/monobuild']
        # They say this is slow... what's the best way to do this?
        PythonPath &quot;sys.path+['/home/wberrier/wa/msvn/release/pyutils']&quot;
        PythonDebug On
&lt;/Directory&gt;
</pre>
<p>You'll need the following changes to view log files from the browser:
</p><p>Append 'log log.gz' to the 'text/plain' entry in /etc/apache2/mime.types so it matches the following:
</p>
<pre>text/plain txt asc log log.gz
</pre>
<p>For /etc/apache2/mod_mime-defaults.conf, uncomment:
</p>
<pre>AddEncoding x-gzip .gz .tgz
</pre>
<p>and comment out:
</p>
<pre>#AddType application/x-gzip .gz .tgz
</pre>
<p>In /etc/apache2/default-server.conf, set DocumentRoot:
</p>
<pre>DocumentRoot "/home/wberrier/wa/msvn/release/monobuild/www"
</pre>
<p>and replace the corresponding &lt;Directory &gt; tag with the same path.
</p><p>Update "Options" in the &lt;Directory&gt; stanza to be:
</p>
<pre>Options FollowSymLinks Indexes MultiViews
</pre>
<p>That should be it!  The mime handling changes are for viewing the compressed log files that monobuild creates.  Unfortunately, InternetExplorer opens these unix formatted files in notepad, which looks horrible.  Open them instead in an editor that understands unix line endings.
</p>
