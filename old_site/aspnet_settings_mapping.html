---
layout: obsolete
title: "ASP.NET Settings Mapping"
permalink: /old_site/ASP.NET_Settings_Mapping/
redirect_from:
  - /ASP.NET_Settings_Mapping/
---

<h1>ASP.NET Settings Mapping</h1>

<p><b>by Marek Habersack</b>
</p><p><b>Note: this document applies to the SVN trunk version of Mono (as of 01 March 2008) and to Mono 1.9 and newer</b>
</p><p><b>Note: as of svn trunk revision 91160, the application-specific settings mapper configuration file name has changed to settings.map.config</b>
</p><p>When developing ASP.NET applications which may be ran by the end user on either MS.NET/ISS or Mono/XSP/mod_mono,
one may face a limitation of the .NET configuration system - the lack of conditional configuration constructs.
Being unable to use different configuration settings for different operating systems/platforms, means that most of the
time it is necessary to provide separate set of config files for every operating environment that differs to the
other ones we support. 
</p><p>One example when such need arises is the usage of the WebParts feature of ASP.NET 2.0. As you
may know, Mono currently does not support that feature and so applications which can optionally use it (like, e.g. MojoPortal)
need to ship with a special configuration for Mono which excludes the WebPart configuration settings. Using settings mapping,
it is possible to ignore the configuration sections related (and unsupported) by Mono. 
</p><p>Another, perhaps more common, scenario are file paths used in the Web.config file. Windows and Unix use different directory
separator characters, Windows supports drive letters while Unix does not use them, a different character is (by convention) used
to separate PATH-style variables under Windows (:) and Unix (;). While all those differencies can be dealt with easily in the
application source code, it is not so for configuration files. A custom settings mapper can take care of the adjustments for
you, seamlessly modifying "canonical" file paths used in the config file to the operating system the application runs on.
</p><p>A new Mono-specific feature has landed in the SVN trunk a few days ago which hopes to address the problem - the Settings
Mapping Manager. What it does, in short, is to load its own configuration file which describes how to map configuration
settings for different operating systems. This is done dynamically on the execution time, so you no longer need to worry
about providing separate configuration files - you can make them adjust to the runtime operating system. The feature has been
designed so that it has the smallest possible impact on application performance. The feature is available only for the 2.0
profile, that is - it is supported only with ASP.NET 2.0 and newer applications.
</p><p>This document introduces all the components of the mapping system and shows an example of how to implement your own
settings mapper.
</p><p><br />
</p>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Table of contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Settings_Mapping_Manager"><span class="tocnumber">1</span> <span class="toctext">Settings Mapping Manager</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Inhibiting_the_settings_mapping"><span class="tocnumber">2</span> <span class="toctext">Inhibiting the settings mapping</span></a></li>
<li class="toclevel-1 tocsection-3"><a href="#The_settings.map_file"><span class="tocnumber">3</span> <span class="toctext">The settings.map file</span></a>
<ul>
<li class="toclevel-2 tocsection-4"><a href="#The_global_settings.map_file"><span class="tocnumber">3.1</span> <span class="toctext">The global settings.map file</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#settings.map_syntax"><span class="tocnumber">3.2</span> <span class="toctext">settings.map syntax</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Sample_settings.map_file"><span class="tocnumber">3.3</span> <span class="toctext">Sample settings.map file</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-7"><a href="#Creating_a_custom_mapper"><span class="tocnumber">4</span> <span class="toctext">Creating a custom mapper</span></a></li>
<li class="toclevel-1 tocsection-8"><a href="#Example_mapper_code"><span class="tocnumber">5</span> <span class="toctext">Example mapper code</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="#AppSettingsMapper_source_code"><span class="tocnumber">5.1</span> <span class="toctext">AppSettingsMapper source code</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#default.aspx"><span class="tocnumber">5.2</span> <span class="toctext">default.aspx</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#Web.config"><span class="tocnumber">5.3</span> <span class="toctext">Web.config</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#settings.map.config"><span class="tocnumber">5.4</span> <span class="toctext">settings.map.config</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-13"><a href="#Final_notes"><span class="tocnumber">6</span> <span class="toctext">Final notes</span></a></li>
</ul>
</td></tr></table>
<h2> <span class="mw-headline" id="Settings_Mapping_Manager"> Settings Mapping Manager </span></h2>
<p>SettingsMappingManager is a simple class in the Mono.Web.Util (in the Mono.Web.dll assembly, available only for the 2.0 profile) namespace which loads the settings mapper configuration
from the 'settings.map' file found in the global configuration files directory ($prefix/etc/mono/2.0/ on Unix) and from the
application-specific 'settings.map.config' file in the top-level directory of your ASP.NET application. 
The files are read only during the application startup phase, just after the web configuration system is initialized. It is important
to remember that, since uploading a 'settings.map' file to your application root after it has been started will NOT have the
desired effect - the uploaded file will be ignored until the next time the application is started. Mapping file in the application
directory is loaded after the global one and it can override all the mappings defined in the latter location.
After the mapping settings are loaded the Settings Mapping Manager does nothing until a section is requested from the configuration
system using code similar to:
</p>
<pre class="csharp" style="font-family:monospace;">MembershipSection ms <span style="color: #008000;">=</span> WebConfigurationManager <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;system.web/membership&quot;</span><span style="color: #008000;">&#41;</span> <span style="color: #0600FF; font-weight: bold;">as</span> MembershipSection<span style="color: #008000;">;</span></pre>
<p>The returned section, if any, will be mapped by the SettingsMappingManager if any mappers are defined for that particular section
type and the operating system the application executes under. The result is cached for performance until configuration file(s) are 
reloaded and the application is restarted to reflect the configuration changes.
</p><p><br />
</p>
<h2> <span class="mw-headline" id="Inhibiting_the_settings_mapping"> Inhibiting the settings mapping </span></h2>
<p>If you don't want the mapping to be performed while your application runs, you can turn it off in one of two ways. The first way
is to set an environment variable before starting your web server - <tt><b>MONO_ASPNET_INHIBIT_SETTINGSMAP</b></tt>. The presence of the variable
is checked for during the SettingsMappingManager initialization phase, very early in the application startu process.
The other way is to put the following fragment in your ASP.NET application's root Web.config file:
</p>
<pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;appSettings<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
	<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;add</span> <span style="color: #000066;">key</span>=<span style="color: #ff0000;">&quot;MonoAspnetInhibitSettingsMap&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;anything&quot;</span><span style="color: #000000; font-weight: bold;">/&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/appSettings<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre>
<h2> <span class="mw-headline" id="The_settings.map_file"> The settings.map file </span></h2>
<p>As described above, the file may be found in two locations - the global configuration directory, as shipped with Mono, and the
top-level ASP.NET application directory where the file is named <tt>settings.map.config</tt> (the <i>.config</i> extension is protected from downloading on all .NET systems). It is an XML file which assigns settings mappers to configuration section handler types
and describes the way in which the mappings are to be performed.
</p><p>The mappings are described in a very generic way so that the actual mapping steps can be performed by the mapper class in the most
flexible way possible. Each mapper is defined for a specific operating system and is not loaded when application doesn't run on
that operating system.
</p><p><br />
</p>
<h3> <span class="mw-headline" id="The_global_settings.map_file"> The global settings.map file </span></h3>
<p>Mono ships a default mapping file which, currently, defines two mappings - one for the Membership Section and the other for the
Role Manager section. The two mappers change the default provider definitions for, respectively. Membership and Role providers when
running under Unix so that they don't use the MS SQL databases/providers (which are unsupported under Unix) but instead use the
(also recently added to Mono) respective Sqlite providers. The affected provider definitions are named 'AspNetSqlMembershipProvider' 
and 'AspNetSqlRoleProvider'.
</p><p><br />
</p>
<h3> <span class="mw-headline" id="settings.map_syntax"> settings.map syntax </span></h3>
<p>The root element of the mapping file must be the 'settingsMap' tag:
</p>
<pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;?xml</span> <span style="color: #000066;">version</span>=<span style="color: #ff0000;">&quot;1.0&quot;</span> <span style="color: #000066;">encoding</span>=<span style="color: #ff0000;">&quot;utf-8&quot;</span><span style="color: #000000; font-weight: bold;">?&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;settingsMap<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/settingsMap<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre>
<p>Only two tags are supported as children of the root node: <i>clear</i> and <i>what</i>.
</p><p>The <i>clear</i> tag simply clears the collection of mappers collected so far. It takes no attributes and is useful when you want to
override/nullify the effect of the global mappers shipped by mono.
</p><p>The <i>map</i> tag defines a mapper for a particular configuration section:
</p>
<pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;map</span> <span style="color: #000066;">sectionType</span>=<span style="color: #ff0000;">&quot;[Full Section Handler Type]&quot;</span></span>
<span style="color: #009900;">     <span style="color: #000066;">mapperType</span>=<span style="color: #ff0000;">&quot;[Full Mapper Type]&quot;</span></span>
<span style="color: #009900;">     <span style="color: #000066;">platform</span>=<span style="color: #ff0000;">&quot;[Platform]&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></pre>
<p>The <i>sectionType</i> attribute names the assembly-qualified type of the configuration section handler which the mapper will process.
The <i>mapperType</i> names the assembly-qualified type of the mapper class itself.
The <i>platform</i> atribute takes the value of one of Windows or Unix to specify which platform the mapper is valid for.
</p><p>The <i>map</i> element can contain any number of the <i>what</i> tag instances. Each <i>what</i> tag defines a mapper-specific region the mapper will work on:
</p>
<pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;what</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;[anything]&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span></pre>
<p>Contents of the <i>value</i> attribute is understood only to the mapper and can be any expression supported by it to denote the associated section region to work on.
The <i>what</i> element can contain any number of instances of several child tags, described below.
</p>
<ul><li> <b>clear</b> - remove all the settings defined by the configuration section region denoted by the 'what' tag
</li><li> <b>add</b> - add a new setting to the configuration section region.
</li><li> <b>replace</b> - replace the contents of the specified setting inside the configuration section region with a new value (or set of values)
</li><li> <b>remove</b> - remove the specified setting from the configuration section contents
</li></ul>
<p>All of the tags above take any number of undefined attributes, all of which are read verbatim and stored for mapper use. Their names and
values are not processed by the Settings Mapping Manager, as the manager doesn't understand the configuration section being mapped. The
mapper is free to interpret the atributes and their values in any way it sees fit to perform the mapping. Even more so, the meanings of the
child tags described above can change from mapper to mapper if it is necessary. This approach allows for the maximum flexibility while
preserving common configuration syntax for all the mappers.
</p><p><br />
</p>
<h3> <span class="mw-headline" id="Sample_settings.map_file"> Sample settings.map file </span></h3>
<p>This is the global settings.map file as currently shipped with Mono:
</p>
<pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;?xml</span> <span style="color: #000066;">version</span>=<span style="color: #ff0000;">&quot;1.0&quot;</span> <span style="color: #000066;">encoding</span>=<span style="color: #ff0000;">&quot;utf-8&quot;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;settingsMap<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;map</span> <span style="color: #000066;">sectionType</span>=<span style="color: #ff0000;">&quot;System.Web.Configuration.MembershipSection, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot;</span></span>
<span style="color: #009900;">       <span style="color: #000066;">mapperType</span>=<span style="color: #ff0000;">&quot;Mono.Web.Util.MembershipSectionMapper, Mono.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&#160;
    <span style="color: #808080; font-style: italic;">&lt;!-- The 'what' tag specifies which region of the section to modify. The 'value' attribute value is mapper-specific and is not defined here. It can be</span>
<span style="color: #808080; font-style: italic;">         any expression understood by the mapper to designate the section region to modify.</span>
<span style="color: #808080; font-style: italic;">    --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;what</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;providers&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #808080; font-style: italic;">&lt;!-- 'what' can contain any number of occurrences of any three elements:</span>
<span style="color: #808080; font-style: italic;">              replace - replace the designated region</span>
<span style="color: #808080; font-style: italic;">              add - add a new entry to the region</span>
<span style="color: #808080; font-style: italic;">              clear - clear the region</span>
<span style="color: #808080; font-style: italic;">              remove - remove the designatedregion</span>
&#160;
<span style="color: #808080; font-style: italic;">              The attributes to any of the above are freeform and are not processed by the mapper manager. They are stored verbatim for the</span>
<span style="color: #808080; font-style: italic;">              mapper to peruse.</span>
<span style="color: #808080; font-style: italic;">      --&gt;</span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;replace</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;AspNetSqlMembershipProvider&quot;</span> </span>
<span style="color: #009900;">               <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;System.Web.Security.SqliteMembershipProvider, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot;</span> </span>
<span style="color: #009900;">               <span style="color: #000066;">connectionStringName</span>=<span style="color: #ff0000;">&quot;LocalSqliteServer&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/what<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/map<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
&#160;
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;map</span> <span style="color: #000066;">sectionType</span>=<span style="color: #ff0000;">&quot;System.Web.Configuration.RoleManagerSection, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot;</span></span>
<span style="color: #009900;">       <span style="color: #000066;">mapperType</span>=<span style="color: #ff0000;">&quot;Mono.Web.Util.RoleManagerSectionMapper, Mono.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot;</span></span>
<span style="color: #009900;">       <span style="color: #000066;">platform</span>=<span style="color: #ff0000;">&quot;Unix&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&#160;
    <span style="color: #808080; font-style: italic;">&lt;!-- The 'what' tag specifies which region of the section to modify. The 'value' attribute value is mapper-specific and is not defined here. It can be</span>
<span style="color: #808080; font-style: italic;">         any expression understood by the mapper to designate the section region to modify.</span>
<span style="color: #808080; font-style: italic;">    --&gt;</span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;what</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;providers&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #808080; font-style: italic;">&lt;!-- 'what' can contain any number of occurrences of any three elements:</span>
<span style="color: #808080; font-style: italic;">              replace - replace the designated region</span>
<span style="color: #808080; font-style: italic;">              add - add a new entry to the region</span>
<span style="color: #808080; font-style: italic;">              clear - clear the region</span>
<span style="color: #808080; font-style: italic;">              remove - remove the designatedregion</span>
&#160;
<span style="color: #808080; font-style: italic;">              The attributes to any of the above are freeform and are not processed by the mapper manager. They are stored verbatim for the</span>
<span style="color: #808080; font-style: italic;">              mapper to peruse.</span>
<span style="color: #808080; font-style: italic;">      --&gt;</span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;replace</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;AspNetSqlRoleProvider&quot;</span> </span>
<span style="color: #009900;">               <span style="color: #000066;">type</span>=<span style="color: #ff0000;">&quot;System.Web.Security.SqliteRoleProvider, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot;</span> </span>
<span style="color: #009900;">               <span style="color: #000066;">connectionStringName</span>=<span style="color: #ff0000;">&quot;LocalSqliteServer&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/what<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/map<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/settingsMap<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre>
<h2> <span class="mw-headline" id="Creating_a_custom_mapper"> Creating a custom mapper </span></h2>
<p>Each mapper must implement the <tt>Mono.Web.Util.ISectionSettingsMapper</tt> interface:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #6666cc; font-weight: bold;">interface</span> ISectionSettingsMapper
<span style="color: #008000;">&#123;</span>
    <span style="color: #6666cc; font-weight: bold;">object</span> MapSection <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">object</span> section, List <span style="color: #008000;">&lt;</span>SettingsMappingWhat<span style="color: #008000;">&gt;</span> whats<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span></pre>
<p>The MapSection method is called to perform actual mapping. The <b>section<i> parameter is the retrieved section to operate on and </i></b><i>whats'</i> is a list of all the <b>what</b> tag instances inside the corresponding mapper section in the settings.map file. 
</p><p><tt>SettingsMappingWhat</tt> exposes the following public members of interest to the mapper:
</p>
<ul><li> <b>string Value</b> - a read-only property which returns the <i>value</i> attribute of the corresponding <i>what</i> tag
</li><li> <b>List &lt;SettingsMappingWhatContents&gt; Contents</b> - a read-only property which returns a collection of objects which describe each of the supported tags within the <i>what</i> container.
</li></ul>
<p><tt>SettingsMappingWhatContents</tt> exposes the following public members of interest to the mapper;
</p>
<ul><li> <b>SettingsMappingWhatOperation Operation</b> - a read-only property which specifies what operation the current instance describes (one of: Add, Clear, Replace, Remove)
</li><li> <b>Dictionary &lt;string, string&gt; Attributes</b> - a read-only property which returns a dictionary of all attributes parsed from the corresponding tag in the settings.map file. The names and values of tags are passed verbatim from the config file to the mapper.
</li></ul>
<p>The return value of the MapSection method must be the <b>section</b> object - whether or not it is of the type expected by the mapper. 
The mapper must not create a new section and return it instead of the passed <b>section</b> object. It must act upon the passed object (if it is of the expected type) and modify its contents instead. 
</p><p>The only exception to the above rule is when you're mapping the AppSettingsSection. The reason is that this section contains an 
override of the GetRuntimeObject method and returns a freshly allocated, read-only, NameValueCollection collection of key/value 
pairs which cannot be modified by the user. In this case, your mapper should allocate a new NameValueCollection, create a copy
of the original one, modify it and return the new object. Another peculiarity of the AppSettingsSection is that it is not
cacheable, since every time it is requested it returns a new object of the NameValueCollection type. Therefore, the mappings will
be performed every time WebConfigurationManager.AppSettings is accessed. You can avoid that by caching the return value of the 
property in your methods.
</p><p>MapSection should avoid throwing exceptions, unless it is absolutely necessary, and it must never return a null value.
</p><p><br />
</p>
<h2> <span class="mw-headline" id="Example_mapper_code"> Example mapper code </span></h2>
<p>This example will show you how to implement a simple AppSettings mapper. It will perform two simple operations on the
application settings collection: process the value of the <i>MyFilePath</i> setting to adjust the path in accordance with the
operating system conventions and add another setting - <i>MyPlatform</i> - which will contain the name of the platform the application
is running on. The remaining files needed for the sample to work can be found below the code of the mapper.
</p><p>You can either compile the mapper into an assembly and put it in the <tt>bin/</tt> subdirectory of your top-level application 
directory or you can put the source code of the mapper inside the <tt>App_Code/</tt> subdirectory of the top-level application 
directory. In this example we're taking the latter approach.
</p><p>Create a new file, <tt>App_Code/AppSettingsMapper.cs</tt> and paste into it the skeleton code below:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System.Collections.Generic</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System.Collections.Specialized</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System.IO</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Mono.Web.Util</span><span style="color: #008000;">;</span>
&#160;
<span style="color: #0600FF; font-weight: bold;">namespace</span> MapperSamples
<span style="color: #008000;">&#123;</span>
	<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> AppSettingsMapper <span style="color: #008000;">:</span> ISectionSettingsMapper
	<span style="color: #008000;">&#123;</span>
		<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">object</span> MapSection <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">object</span> section, List <span style="color: #008000;">&lt;</span>SettingsMappingWhat<span style="color: #008000;">&gt;</span> whats<span style="color: #008000;">&#41;</span>
		<span style="color: #008000;">&#123;</span>
&#160;
		<span style="color: #008000;">&#125;</span>
	<span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p>The above code declares a class which fullfills all the requirements of a settings mapper. It implements
the <tt>ISectionSettingsMapper</tt> interface and is public, so that it can be loaded by <tt>SettingsMappingManager</tt>.
</p><p>At the very beginning, each mapper should check whether the section object passed to it is actually of the expected type. Let's add code which does just that to the MapSection method:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">object</span> MapSection <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">object</span> section, List <span style="color: #008000;">&lt;</span>SettingsMappingWhat<span style="color: #008000;">&gt;</span> whats<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
	NameValueCollection nvcOrig <span style="color: #008000;">=</span> section <span style="color: #0600FF; font-weight: bold;">as</span> NameValueCollection<span style="color: #008000;">;</span>
	<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>nvcOrig <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span>
		<span style="color: #0600FF; font-weight: bold;">return</span> section<span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span></pre>
<p>As you may remember from above, the AppSettingsSection configuration section handler is special in that it overrides the
GetRuntimeObject method and returns a NameValueCollection instead of itself. That's why we perform a check on whether the
passed section is of that type and not of AppSettingsSection. The reality is even more complicated, since the object returned
by AppSettingsSecton's GetRuntimeObject is of the internal KeyValueInternalCollection type which is inaccessible to us, but since
it derives from the NameValueCollection class, we can use the latter without problems to access the collection.
</p><p>After making sure that we get what we expect, we need to create a copy of the passed section object (for the reasons described previously):
</p>
<pre class="csharp" style="font-family:monospace;">NameValueCollection nvc <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> NameValueCollection <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">foreach</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">string</span> key <span style="color: #0600FF; font-weight: bold;">in</span> nvcOrig<span style="color: #008000;">.</span><span style="color: #0000FF;">AllKeys</span><span style="color: #008000;">&#41;</span>  <span style="color: #008000;">&#123;</span>
	<span style="color: #6666cc; font-weight: bold;">string</span> val <span style="color: #008000;">=</span> nvcOrig <span style="color: #008000;">&#91;</span>key<span style="color: #008000;">&#93;</span> <span style="color: #0600FF; font-weight: bold;">as</span> <span style="color: #6666cc; font-weight: bold;">String</span><span style="color: #008000;">;</span>
	<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>val <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span>
		<span style="color: #0600FF; font-weight: bold;">continue</span><span style="color: #008000;">;</span>
&#160;
	nvc <span style="color: #008000;">&#91;</span>key<span style="color: #008000;">&#93;</span> <span style="color: #008000;">=</span> val<span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span></pre>
<p>After that's done, we can start executing all the actions defined for us in the settings.map file:
</p>
<pre class="csharp" style="font-family:monospace;">List <span style="color: #008000;">&lt;</span>SettingsMappingWhatContents<span style="color: #008000;">&gt;</span> contents<span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">foreach</span> <span style="color: #008000;">&#40;</span>SettingsMappingWhat what <span style="color: #0600FF; font-weight: bold;">in</span> whats<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
	contents <span style="color: #008000;">=</span> what<span style="color: #008000;">.</span><span style="color: #0000FF;">Contents</span><span style="color: #008000;">;</span>
	<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>contents <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span> <span style="color: #008000;">||</span> contents<span style="color: #008000;">.</span><span style="color: #0000FF;">Count</span> <span style="color: #008000;">==</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">&#41;</span>
		<span style="color: #0600FF; font-weight: bold;">continue</span><span style="color: #008000;">;</span>
&#160;
	<span style="color: #0600FF; font-weight: bold;">foreach</span> <span style="color: #008000;">&#40;</span>SettingsMappingWhatContents item <span style="color: #0600FF; font-weight: bold;">in</span> contents<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
		<span style="color: #0600FF; font-weight: bold;">switch</span> <span style="color: #008000;">&#40;</span>item<span style="color: #008000;">.</span><span style="color: #0000FF;">Operation</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
			<span style="color: #0600FF; font-weight: bold;">case</span> SettingsMappingWhatOperation<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Add</span><span style="color: #008000;">:</span>
				ProcessAdd <span style="color: #008000;">&#40;</span>nvc, item<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
				<span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
&#160;
			<span style="color: #0600FF; font-weight: bold;">case</span> SettingsMappingWhatOperation<span style="color: #008000;">.</span><span style="color: #0000FF;">Clear</span><span style="color: #008000;">:</span>
				<span style="color: #008080; font-style: italic;">// ignore</span>
				<span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
&#160;
			<span style="color: #0600FF; font-weight: bold;">case</span> SettingsMappingWhatOperation<span style="color: #008000;">.</span><span style="color: #0000FF;">Replace</span><span style="color: #008000;">:</span>
				ProcessReplace <span style="color: #008000;">&#40;</span>nvc, item<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
				<span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
&#160;
			<span style="color: #0600FF; font-weight: bold;">case</span> SettingsMappingWhatOperation<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Remove</span><span style="color: #008000;">:</span>
				<span style="color: #008080; font-style: italic;">// ignore</span>
				<span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
		<span style="color: #008000;">&#125;</span>
	<span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span>
&#160;
<span style="color: #0600FF; font-weight: bold;">return</span> nvc<span style="color: #008000;">;</span></pre>
<p>The code traverses the list of whats and for each of them, it looks at the collection of operations to perform and then
dispatches the operation to the correct handler. Since our example only replaces a single key in the settings and adds
another, we define only the Replace and Add handlers:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #6666cc; font-weight: bold;">void</span> ProcessAdd <span style="color: #008000;">&#40;</span>NameValueCollection nvc, SettingsMappingWhatContents what<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
	Dictionary <span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">string</span>, <span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">&gt;</span> attrs <span style="color: #008000;">=</span> what<span style="color: #008000;">.</span><span style="color: #0000FF;">Attributes</span><span style="color: #008000;">;</span>
&#160;
	<span style="color: #6666cc; font-weight: bold;">string</span> name<span style="color: #008000;">;</span>
	<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">!</span>attrs<span style="color: #008000;">.</span><span style="color: #0000FF;">TryGetValue</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;name&quot;</span>, <span style="color: #0600FF; font-weight: bold;">out</span> name<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
		<span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&#160;
	<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>name <span style="color: #008000;">!=</span> <span style="color: #666666;">&quot;MyPlatform&quot;</span><span style="color: #008000;">&#41;</span>
		<span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&#160;
	nvc <span style="color: #008000;">&#91;</span>name<span style="color: #008000;">&#93;</span> <span style="color: #008000;">=</span> SettingsMappingManager<span style="color: #008000;">.</span><span style="color: #0000FF;">Platform</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ToString</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span></pre>
<p>This handler simply makes sure that the entry requested to be added is named 'MyPlatform' and uses the SettingsMappingManager.Platform
to set the value of that setting.
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #6666cc; font-weight: bold;">void</span> ProcessReplace <span style="color: #008000;">&#40;</span>NameValueCollection nvc, SettingsMappingWhatContents what<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
	Dictionary <span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">string</span>, <span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">&gt;</span> attrs <span style="color: #008000;">=</span> what<span style="color: #008000;">.</span><span style="color: #0000FF;">Attributes</span><span style="color: #008000;">;</span>
&#160;
	<span style="color: #6666cc; font-weight: bold;">string</span> name, relativeTo<span style="color: #008000;">;</span>
	<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">!</span>attrs<span style="color: #008000;">.</span><span style="color: #0000FF;">TryGetValue</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;name&quot;</span>, <span style="color: #0600FF; font-weight: bold;">out</span> name<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
		<span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&#160;
	<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">!</span>attrs<span style="color: #008000;">.</span><span style="color: #0000FF;">TryGetValue</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;relativeTo&quot;</span>, <span style="color: #0600FF; font-weight: bold;">out</span> relativeTo<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
		relativeTo <span style="color: #008000;">=</span> <span style="color: #666666;">&quot;UserHome&quot;</span><span style="color: #008000;">;</span>
&#160;
	<span style="color: #0600FF; font-weight: bold;">switch</span> <span style="color: #008000;">&#40;</span>relativeTo<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
		<span style="color: #0600FF; font-weight: bold;">case</span> <span style="color: #666666;">&quot;UserHome&quot;</span><span style="color: #008000;">:</span>
			MakeRelativeToUserHome <span style="color: #008000;">&#40;</span>nvc, name<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
			<span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
	<span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p>Above you can observe what was described previously, that every operation tag's attrbutes are passed verbatim to the mapper.
We specified a 'relativeTo' attribute whose value is to tell the mapper how to replace the path placeholder inside the
original setting value. The placeholder value in our case is <i>@PATH_PLACEHOLDER@</i> and is replaced with the value of the
user's home/private directory.
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #6666cc; font-weight: bold;">void</span> MakeRelativeToUserHome <span style="color: #008000;">&#40;</span>NameValueCollection nvc, <span style="color: #6666cc; font-weight: bold;">string</span> name<span style="color: #008000;">&#41;</span>
<span style="color: #008000;">&#123;</span>
	<span style="color: #6666cc; font-weight: bold;">string</span> path <span style="color: #008000;">=</span> nvc <span style="color: #008000;">&#91;</span>name<span style="color: #008000;">&#93;</span><span style="color: #008000;">;</span>
	<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">String</span><span style="color: #008000;">.</span><span style="color: #0000FF;">IsNullOrEmpty</span> <span style="color: #008000;">&#40;</span>path<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
		<span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&#160;
	<span style="color: #6666cc; font-weight: bold;">string</span> userDir <span style="color: #008000;">=</span> Environment<span style="color: #008000;">.</span><span style="color: #0000FF;">GetFolderPath</span> <span style="color: #008000;">&#40;</span>Environment<span style="color: #008000;">.</span><span style="color: #0000FF;">SpecialFolder</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Personal</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">+</span> Path<span style="color: #008000;">.</span><span style="color: #0000FF;">DirectorySeparatorChar</span><span style="color: #008000;">;</span>
	path <span style="color: #008000;">=</span> path<span style="color: #008000;">.</span><span style="color: #0000FF;">Replace</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;@PATH_PLACEHOLDER@&quot;</span>, userDir<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
	nvc <span style="color: #008000;">&#91;</span>name<span style="color: #008000;">&#93;</span> <span style="color: #008000;">=</span> path<span style="color: #008000;">;</span>
<span style="color: #008000;">&#125;</span></pre>
<p>This is the code that performs the actual replacement of the directory path placeholder.
</p>
<h3> <span class="mw-headline" id="AppSettingsMapper_source_code"> AppSettingsMapper source code </span></h3>
<p>For your convenience, this is the full code of the AppSettingsMapper class in once piece, paste it into <tt>App_Code/AppSettingsMapper.cs</tt>:
</p>
<pre class="csharp" style="font-family:monospace;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System.Collections.Generic</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System.Collections.Specialized</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System.IO</span><span style="color: #008000;">;</span>
<span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Mono.Web.Util</span><span style="color: #008000;">;</span>
&#160;
<span style="color: #0600FF; font-weight: bold;">namespace</span> MapperSamples
<span style="color: #008000;">&#123;</span>
	<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> AppSettingsMapper <span style="color: #008000;">:</span> ISectionSettingsMapper
	<span style="color: #008000;">&#123;</span>
		<span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">object</span> MapSection <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">object</span> section, List <span style="color: #008000;">&lt;</span>SettingsMappingWhat<span style="color: #008000;">&gt;</span> whats<span style="color: #008000;">&#41;</span>
		<span style="color: #008000;">&#123;</span>
			NameValueCollection nvcOrig <span style="color: #008000;">=</span> section <span style="color: #0600FF; font-weight: bold;">as</span> NameValueCollection<span style="color: #008000;">;</span>
			<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>nvcOrig <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span>
				<span style="color: #0600FF; font-weight: bold;">return</span> section<span style="color: #008000;">;</span>
&#160;
			NameValueCollection nvc <span style="color: #008000;">=</span> <a href="http://www.google.com/search?q=new+msdn.microsoft.com"><span style="color: #008000;">new</span></a> NameValueCollection <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
			<span style="color: #0600FF; font-weight: bold;">foreach</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">string</span> key <span style="color: #0600FF; font-weight: bold;">in</span> nvcOrig<span style="color: #008000;">.</span><span style="color: #0000FF;">AllKeys</span><span style="color: #008000;">&#41;</span>  <span style="color: #008000;">&#123;</span>
				<span style="color: #6666cc; font-weight: bold;">string</span> val <span style="color: #008000;">=</span> nvcOrig <span style="color: #008000;">&#91;</span>key<span style="color: #008000;">&#93;</span> <span style="color: #0600FF; font-weight: bold;">as</span> <span style="color: #6666cc; font-weight: bold;">String</span><span style="color: #008000;">;</span>
				<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>val <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span><span style="color: #008000;">&#41;</span>
					<span style="color: #0600FF; font-weight: bold;">continue</span><span style="color: #008000;">;</span>
&#160;
				nvc <span style="color: #008000;">&#91;</span>key<span style="color: #008000;">&#93;</span> <span style="color: #008000;">=</span> val<span style="color: #008000;">;</span>
			<span style="color: #008000;">&#125;</span>
&#160;
			List <span style="color: #008000;">&lt;</span>SettingsMappingWhatContents<span style="color: #008000;">&gt;</span> contents<span style="color: #008000;">;</span>
			<span style="color: #0600FF; font-weight: bold;">foreach</span> <span style="color: #008000;">&#40;</span>SettingsMappingWhat what <span style="color: #0600FF; font-weight: bold;">in</span> whats<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
				contents <span style="color: #008000;">=</span> what<span style="color: #008000;">.</span><span style="color: #0000FF;">Contents</span><span style="color: #008000;">;</span>
				<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>contents <span style="color: #008000;">==</span> <span style="color: #0600FF; font-weight: bold;">null</span> <span style="color: #008000;">||</span> contents<span style="color: #008000;">.</span><span style="color: #0000FF;">Count</span> <span style="color: #008000;">==</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">&#41;</span>
					<span style="color: #0600FF; font-weight: bold;">continue</span><span style="color: #008000;">;</span>
&#160;
				<span style="color: #0600FF; font-weight: bold;">foreach</span> <span style="color: #008000;">&#40;</span>SettingsMappingWhatContents item <span style="color: #0600FF; font-weight: bold;">in</span> contents<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
					<span style="color: #0600FF; font-weight: bold;">switch</span> <span style="color: #008000;">&#40;</span>item<span style="color: #008000;">.</span><span style="color: #0000FF;">Operation</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
						<span style="color: #0600FF; font-weight: bold;">case</span> SettingsMappingWhatOperation<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Add</span><span style="color: #008000;">:</span>
							ProcessAdd <span style="color: #008000;">&#40;</span>nvc, item<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
							<span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
&#160;
						<span style="color: #0600FF; font-weight: bold;">case</span> SettingsMappingWhatOperation<span style="color: #008000;">.</span><span style="color: #0000FF;">Clear</span><span style="color: #008000;">:</span>
							<span style="color: #008080; font-style: italic;">// ignore</span>
							<span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
&#160;
						<span style="color: #0600FF; font-weight: bold;">case</span> SettingsMappingWhatOperation<span style="color: #008000;">.</span><span style="color: #0000FF;">Replace</span><span style="color: #008000;">:</span>
							ProcessReplace <span style="color: #008000;">&#40;</span>nvc, item<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
							<span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
&#160;
						<span style="color: #0600FF; font-weight: bold;">case</span> SettingsMappingWhatOperation<span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Remove</span><span style="color: #008000;">:</span>
							<span style="color: #008080; font-style: italic;">// ignore</span>
							<span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
					<span style="color: #008000;">&#125;</span>
				<span style="color: #008000;">&#125;</span>
			<span style="color: #008000;">&#125;</span>
&#160;
			<span style="color: #0600FF; font-weight: bold;">return</span> nvc<span style="color: #008000;">;</span>
		<span style="color: #008000;">&#125;</span>
&#160;
		<span style="color: #6666cc; font-weight: bold;">void</span> ProcessAdd <span style="color: #008000;">&#40;</span>NameValueCollection nvc, SettingsMappingWhatContents what<span style="color: #008000;">&#41;</span>
		<span style="color: #008000;">&#123;</span>
			Dictionary <span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">string</span>, <span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">&gt;</span> attrs <span style="color: #008000;">=</span> what<span style="color: #008000;">.</span><span style="color: #0000FF;">Attributes</span><span style="color: #008000;">;</span>
&#160;
			<span style="color: #6666cc; font-weight: bold;">string</span> name<span style="color: #008000;">;</span>
			<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">!</span>attrs<span style="color: #008000;">.</span><span style="color: #0000FF;">TryGetValue</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;name&quot;</span>, <span style="color: #0600FF; font-weight: bold;">out</span> name<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
				<span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&#160;
			<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span>name <span style="color: #008000;">!=</span> <span style="color: #666666;">&quot;MyPlatform&quot;</span><span style="color: #008000;">&#41;</span>
				<span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&#160;
			nvc <span style="color: #008000;">&#91;</span>name<span style="color: #008000;">&#93;</span> <span style="color: #008000;">=</span> SettingsMappingManager<span style="color: #008000;">.</span><span style="color: #0000FF;">Platform</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ToString</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
		<span style="color: #008000;">&#125;</span>
&#160;
		<span style="color: #6666cc; font-weight: bold;">void</span> ProcessReplace <span style="color: #008000;">&#40;</span>NameValueCollection nvc, SettingsMappingWhatContents what<span style="color: #008000;">&#41;</span>
		<span style="color: #008000;">&#123;</span>
			Dictionary <span style="color: #008000;">&lt;</span><span style="color: #6666cc; font-weight: bold;">string</span>, <span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">&gt;</span> attrs <span style="color: #008000;">=</span> what<span style="color: #008000;">.</span><span style="color: #0000FF;">Attributes</span><span style="color: #008000;">;</span>
&#160;
			<span style="color: #6666cc; font-weight: bold;">string</span> name, relativeTo<span style="color: #008000;">;</span>
			<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">!</span>attrs<span style="color: #008000;">.</span><span style="color: #0000FF;">TryGetValue</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;name&quot;</span>, <span style="color: #0600FF; font-weight: bold;">out</span> name<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
				<span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&#160;
			<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #008000;">!</span>attrs<span style="color: #008000;">.</span><span style="color: #0000FF;">TryGetValue</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;relativeTo&quot;</span>, <span style="color: #0600FF; font-weight: bold;">out</span> relativeTo<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
				relativeTo <span style="color: #008000;">=</span> <span style="color: #666666;">&quot;UserHome&quot;</span><span style="color: #008000;">;</span>
&#160;
			<span style="color: #0600FF; font-weight: bold;">switch</span> <span style="color: #008000;">&#40;</span>relativeTo<span style="color: #008000;">&#41;</span> <span style="color: #008000;">&#123;</span>
				<span style="color: #0600FF; font-weight: bold;">case</span> <span style="color: #666666;">&quot;UserHome&quot;</span><span style="color: #008000;">:</span>
					MakeRelativeToUserHome <span style="color: #008000;">&#40;</span>nvc, name<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
					<span style="color: #0600FF; font-weight: bold;">break</span><span style="color: #008000;">;</span>
			<span style="color: #008000;">&#125;</span>
		<span style="color: #008000;">&#125;</span>
&#160;
		<span style="color: #6666cc; font-weight: bold;">void</span> MakeRelativeToUserHome <span style="color: #008000;">&#40;</span>NameValueCollection nvc, <span style="color: #6666cc; font-weight: bold;">string</span> name<span style="color: #008000;">&#41;</span>
		<span style="color: #008000;">&#123;</span>
			<span style="color: #6666cc; font-weight: bold;">string</span> path <span style="color: #008000;">=</span> nvc <span style="color: #008000;">&#91;</span>name<span style="color: #008000;">&#93;</span><span style="color: #008000;">;</span>
			<span style="color: #0600FF; font-weight: bold;">if</span> <span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">String</span><span style="color: #008000;">.</span><span style="color: #0000FF;">IsNullOrEmpty</span> <span style="color: #008000;">&#40;</span>path<span style="color: #008000;">&#41;</span><span style="color: #008000;">&#41;</span>
				<span style="color: #0600FF; font-weight: bold;">return</span><span style="color: #008000;">;</span>
&#160;
			<span style="color: #6666cc; font-weight: bold;">string</span> userDir <span style="color: #008000;">=</span> Environment<span style="color: #008000;">.</span><span style="color: #0000FF;">GetFolderPath</span> <span style="color: #008000;">&#40;</span>Environment<span style="color: #008000;">.</span><span style="color: #0000FF;">SpecialFolder</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Personal</span><span style="color: #008000;">&#41;</span> <span style="color: #008000;">+</span> Path<span style="color: #008000;">.</span><span style="color: #0000FF;">DirectorySeparatorChar</span><span style="color: #008000;">;</span>
			path <span style="color: #008000;">=</span> path<span style="color: #008000;">.</span><span style="color: #0000FF;">Replace</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;@PATH_PLACEHOLDER@&quot;</span>, userDir<span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span>
			nvc <span style="color: #008000;">&#91;</span>name<span style="color: #008000;">&#93;</span> <span style="color: #008000;">=</span> path<span style="color: #008000;">;</span>
		<span style="color: #008000;">&#125;</span>
	<span style="color: #008000;">&#125;</span>
<span style="color: #008000;">&#125;</span></pre>
<p>The remaining files required for the mapper example to work
</p>
<h3> <span class="mw-headline" id="default.aspx">default.aspx</span></h3>
<pre>
&lt;%@ Page Language=&quot;C#&quot;&#160;%&gt;
&lt;%@ Import Namespace=&quot;System.Web.Configuration&quot;&#160;%&gt;

&lt;script runat=&quot;server&quot;&gt;
public void Page_Load (object sender, EventArgs args)
{
        NameValueCollection settings = (NameValueCollection) WebConfigurationManager.GetSection (&quot;appSettings&quot;);
        myFilePathValue.Text = settings [&quot;MyFilePath&quot;];
        myPlatformValue.Text = settings [&quot;MyPlatform&quot;];
}
&lt;/script&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Modify File Paths Mapper Sample&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;form runat=&quot;server&quot;&gt;
    &lt;asp:Label runat=&quot;server&quot; Text=&quot;AppSettingsSection mapper test:&quot;/&gt;&lt;br/&gt;
    MyFilePath value: &lt;asp:Literal runat=&quot;server&quot; id=&quot;myFilePathValue&quot;/&gt;&lt;br/&gt;
    MyPlatform value: &lt;asp:Literal runat=&quot;server&quot; id=&quot;myPlatformValue&quot;/&gt;
&lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre>
<h3> <span class="mw-headline" id="Web.config">Web.config</span></h3>
<pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;?xml</span> <span style="color: #000066;">version</span>=<span style="color: #ff0000;">&quot;1.0&quot;</span><span style="color: #000000; font-weight: bold;">?&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;appSettings<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
                <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;add</span> <span style="color: #000066;">key</span>=<span style="color: #ff0000;">&quot;MyFilePath&quot;</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;@PATH_PLACEHOLDER@file.txt&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
        <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/appSettings<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/configuration<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre>
<h3> <span class="mw-headline" id="settings.map.config">settings.map.config</span></h3>
<pre class="xml" style="font-family:monospace;"><span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;?xml</span> <span style="color: #000066;">version</span>=<span style="color: #ff0000;">&quot;1.0&quot;</span> <span style="color: #000066;">encoding</span>=<span style="color: #ff0000;">&quot;utf-8&quot;</span> <span style="color: #000000; font-weight: bold;">?&gt;</span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;settingsMap<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;map</span> <span style="color: #000066;">sectionType</span>=<span style="color: #ff0000;">&quot;System.Configuration.KeyValueInternalCollection, System.Configuration, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a&quot;</span></span>
<span style="color: #009900;">       <span style="color: #000066;">mapperType</span>=<span style="color: #ff0000;">&quot;MapperSamples.AppSettingsMapper, App_Code&quot;</span></span>
<span style="color: #009900;">       <span style="color: #000066;">platform</span>=<span style="color: #ff0000;">&quot;Unix&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
&#160;
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;what</span> <span style="color: #000066;">value</span>=<span style="color: #ff0000;">&quot;ignored&quot;</span><span style="color: #000000; font-weight: bold;">&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;replace</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;MyFilePath&quot;</span> <span style="color: #000066;">relativeTo</span>=<span style="color: #ff0000;">&quot;UserHome&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
      <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;add</span> <span style="color: #000066;">name</span>=<span style="color: #ff0000;">&quot;MyPlatform&quot;</span> <span style="color: #000000; font-weight: bold;">/&gt;</span></span>
    <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/what<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
  <span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/map<span style="color: #000000; font-weight: bold;">&gt;</span></span></span>
<span style="color: #009900;"><span style="color: #000000; font-weight: bold;">&lt;/settingsMap<span style="color: #000000; font-weight: bold;">&gt;</span></span></span></pre>
<p>A word of explanation is required for the above file. You might have noticed that in the mapper we check for the NameValueCollection type of the passed
section and in the above file we define a mapper for the System.Configuration.KeyValueInternalCollection type. This is because that's the exact type
returned by the AppSettingsSection's GetRuntimeObject and that's what the SettingsMappingManager will see when looking for a mapper for the appSettings
section. As already said above, the internal class derives from NameValueCollection. Also, note that the value of the 'mapperType' attribute doesn't
specify the App_Code assembly's version, culture and public key token. This is because App_Code is a "virtual" assembly whose real name is different
and changes between application runs. ASP.NET resolves the name internally to the real dynamically generated assembly.
</p>
<h2> <span class="mw-headline" id="Final_notes">Final notes</span></h2>
<p>It is very important to remember that the settings mapping works ONLY for the ASP.NET applications and ONLY if the sections are requested using the
WebConfigurationManager object, as shown below:
</p>
<pre class="csharp" style="font-family:monospace;">SomeSection section <span style="color: #008000;">=</span> WebConfigurationManager<span style="color: #008000;">.</span><span style="color: #0000FF;">GetSection</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;someSection&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></pre>
<p>Also, when using AppSettings in your application <b>do not</b> access them using either <tt>ConfigurationManager.AppSettings</tt> or <tt>WebConfigurationManager.AppSettings</tt> properties since the section will not be mapped. It's because WebConfigurationManager returns the value of <tt>ConfigurationManager.AppSettings</tt> which uses the ConfigurationManager's version of the GetSection method which does not support settings mapping. You should instead use code as follows:
</p>
<pre class="csharp" style="font-family:monospace;">NameValueCollection settings <span style="color: #008000;">=</span> <span style="color: #008000;">&#40;</span>NameValueCollection<span style="color: #008000;">&#41;</span> WebConfigurationManager<span style="color: #008000;">.</span><span style="color: #0000FF;">GetSection</span> <span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;appSettings&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></pre>
<p>If you plan to run your application on MS.NET/IIS and Mono, then you should configure it for the Windows/MS.NET target and provide configuration settings mappers for other operating systems.
</p>
