---
layout: obsolete
title: "Mono:Runtime:Documentation:Trampolines"
permalink: /old_site/Mono:Runtime:Documentation:Trampolines/
redirect_from:
  - /Mono:Runtime:Documentation:Trampolines/
---

<h1>Mono:Runtime:Documentation:Trampolines</h1>

<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Table of contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Trampolines"><span class="tocnumber">1</span> <span class="toctext">Trampolines</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#JIT_Trampolines"><span class="tocnumber">1.1</span> <span class="toctext">JIT Trampolines</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Virtual_Call_Trampolines"><span class="tocnumber">1.2</span> <span class="toctext">Virtual Call Trampolines</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Jump_Trampolines"><span class="tocnumber">1.3</span> <span class="toctext">Jump Trampolines</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Class_Init_Trampolines"><span class="tocnumber">1.4</span> <span class="toctext">Class Init Trampolines</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Generic_Class_Init_Trampoline"><span class="tocnumber">1.5</span> <span class="toctext">Generic Class Init Trampoline</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#RGCTX_Lazy_Fetch_Trampolines"><span class="tocnumber">1.6</span> <span class="toctext">RGCTX Lazy Fetch Trampolines</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#AOT_Trampolines"><span class="tocnumber">1.7</span> <span class="toctext">AOT Trampolines</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#AOT_PLT_Trampolines"><span class="tocnumber">1.8</span> <span class="toctext">AOT PLT Trampolines</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#Delegate_Trampolines"><span class="tocnumber">1.9</span> <span class="toctext">Delegate Trampolines</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#Monitor_Enter.2FExit_Trampolines"><span class="tocnumber">1.10</span> <span class="toctext">Monitor Enter/Exit Trampolines</span></a></li>
</ul>
</li>
</ul>
</td></tr></table>
<h2> <span class="mw-headline" id="Trampolines"> Trampolines </span></h2>
<p>Trampolines are small, hand-written pieces of assembly code used to perform
various tasks in the mono runtime. They are generated at runtime using the 
native code generation macros used by the JIT. They usually have a corresponding
C function they can fall back to if they need to perform a more complicated task.
They can be viewed as ways to pass control from JITted code back to the runtime.
</p><p>The common code for all architectures is in mini-trampolines.c, this file contains the trampoline creation functions plus the C functions called by the
trampolines. The tramp-&lt;ARCH&gt;.c files contain the arch-dependent code which
creates the trampolines themselves.
</p><p>Most, but not all trampolines consist of two parts:
</p>
<ul><li> a generic part containing most of the code. This is created by the mono_arch_create_trampoline_code () function in tramp-&lt;ARCH&gt;.c. Generic trampolines can be large (1kb).
</li><li> a specific part whose job is to call the generic part, passing in a parameter. The parameter to pass and the method by it is passed depends on the type of the trampoline. Specific trampolines are created by the mono_arch_create_specific_trampoline () function in tramp-&lt;ARCH&gt;.c. Specific trampolines are small, since the runtime creates lots of them.
</li></ul>
<p>The generic part saves the machine state to the stack, and calls one of the
trampoline functions in mini-trampolines.c with the state, the call site, and 
the argument passed by the specific trampoline. After the C function returns, 
it either returns normally, or branches to the address returned by the C function, depending on the trampoline type.
</p><p>Trampoline types are given by the MonoTrampolineType enumeration in <a href="http://anonsvn.mono-project.com/viewvc/trunk/mono/mono/mini/mini.h?view=log" class="external text" rel="nofollow">mini.h</a>.
</p><p>The platform specific code for trampolines is in the file tramp-&lt;ARCH&gt;.c for each architecture, while the cross platform code is in mini-trampolines.c. There are two types of functions in mini-trampolines.c:
</p>
<ul><li> The actual C functions called by the trampolines.
</li><li> Functions to create the different trampolines types.
</li></ul>
<p>Trampoline creation functions have the following signature:
</p>
<pre class="bash" style="font-family:monospace;">gpointer
mono_arch_create_foo_trampoline <span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #000000; font-weight: bold;">&lt;</span>args<span style="color: #000000; font-weight: bold;">&gt;</span>, MonoTrampInfo <span style="color: #000000; font-weight: bold;">**</span>info, gboolean aot<span style="color: #7a0874; font-weight: bold;">&#41;</span></pre>
<p>The function should return a pointer to the newly created trampoline, allocating memory from either the global code manager, or from a domain's code manager. If INFO is not NULL, it is set to a pointer to a MonoTrampInfo structure, which contains information about the trampoline, like its name, unwind info, etc. This is used for two purposes:
</p>
<ul><li> Saving the trampoline info an AOT image in 'full-aot' mode.
</li><li> Saving debug info about the trampoline in XDEBUG mode.
</li></ul>
<h3> <span class="mw-headline" id="JIT_Trampolines"> JIT Trampolines </span></h3>
<p>These trampolines are used to JIT compile a method the first time it is called.
When the JIT compiles a call instruction, it doesn't compile the called method right away. Instead, it creates a JIT trampoline, and emits a call instruction
referencing the trampoline. When the trampoline is called, it calls
mono_magic_trampoline () which compiles the target method, and returns the
address of the compiled code to the trampoline which branches to it.
This process is somewhat slow, so mono_magic_trampoline () tries to patch the
calling JITted code so it calls the compiled code instead of the trampoline from
now on. This is done by mono_arch_patch_callsite () in tramp-&lt;ARCH&gt;.c.
</p>
<h3> <span class="mw-headline" id="Virtual_Call_Trampolines"> Virtual Call Trampolines </span></h3>
<p>There is one virtual call trampoline per vtable slot index. The trampoline uses this index plus the 'this' argument which is passed in a fixed register/stack slots by the managed calling convention to obtain the virtual method which needs to be compiled. It then patches the vtable slot with the address of the newly
compiled method.
</p><p>&lt;TODO IMT&gt;
</p>
<h3> <span class="mw-headline" id="Jump_Trampolines"> Jump Trampolines </span></h3>
<p>Jump trampolines are very similar to JIT trampolines, they even use the
same mono_magic_trampoline () C function. They are used to implement the
LDFTN and the JMP IL opcodes.
</p>
<h3> <span class="mw-headline" id="Class_Init_Trampolines"> Class Init Trampolines </span></h3>
<p>These trampolines are used to implement the type initialization sematics of
the CLI spec. They call the mono_class_init_trampoline () C function which
executes the class initializer of the class passed as the trampoline argument,
then replaces the code calling the class init trampoline with NOPs so it is
not executed anymore.
</p>
<h3> <span class="mw-headline" id="Generic_Class_Init_Trampoline"> Generic Class Init Trampoline </span></h3>
<p>This is similar to the class init trampolines, but is used for initalizing
classes which are only known at run-time, in generic-shared code. It receives the class to be initialized in a register instead of from a specific trampoline. This means there is only one instance of this trampoline.
</p>
<h3> <span class="mw-headline" id="RGCTX_Lazy_Fetch_Trampolines"> RGCTX Lazy Fetch Trampolines </span></h3>
<p>These are used for fetching values from a runtime generic context, lazily initializing the values if they do not exist yet. There is one instance of
this trampoline for each offset value.
</p>
<h3> <span class="mw-headline" id="AOT_Trampolines"> AOT Trampolines </span></h3>
<p>These are similar to the JIT trampolines but instead of receiving a MonoMethod
to compile, they receive an image+token pair. If the method identified by this
pair is also AOT compiled, the address of its compiled code can be obtained
without loading the metadata for the method.
</p>
<h3> <span class="mw-headline" id="AOT_PLT_Trampolines"> AOT PLT Trampolines </span></h3>
<p>These trampolines handle calls made from AOT code though the PLT. 
</p>
<h3> <span class="mw-headline" id="Delegate_Trampolines"> Delegate Trampolines </span></h3>
<p>These trampolines are used to handle the first call made to the delegate though
its Invoke method. They call mono_delegate_trampoline () which creates a
specialized calling sequence optimized to the delegate instance before calling
it. Further calls will go through to this optimized code sequence.
</p>
<h3> <span class="mw-headline" id="Monitor_Enter.2FExit_Trampolines"> Monitor Enter/Exit Trampolines </span></h3>
<p>These trampolines implement the fastpath of Monitor.Enter/Exit on some platforms.
</p><p>&lt;TODO REMAINING TRAMPOLINE TYPES&gt;
</p>
